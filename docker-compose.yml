# Docker Compose for Local Development
#
# ARCHITECTURE - Mirrors Lightsail Production
#
# Production:  nginx → Express API → PostgreSQL (RDS)
# Local:       nginx → Express API → PostgreSQL (container)
#
# Services:
# - nginx: Reverse proxy + static files (mirrors prod exactly)
# - api: Unified Express server (API + Recording + Media Processing)
# - postgres: Database (mirrors RDS)
# - mailhog: Email testing (mirrors SES)
# - pgadmin: Optional database management UI

services:
  # ============================================
  # Nginx (Mirrors Production)
  # Serves web-admin static files + proxies API
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: family-helper-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./web-admin/dist:/usr/share/nginx/html:ro
    depends_on:
      - api
    networks:
      - family-helper-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Unified API Server
  # Everything in one container (like Lightsail)
  # ============================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: family-helper-api
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      # Database - use local postgres
      DATABASE_URL: postgresql://familyhelper_admin:localdev123@postgres:5432/familyhelper
      # S3 - use production S3 for file storage (or local for dev)
      S3_BUCKET: ${S3_BUCKET:-family-helper-files-prod}
      AWS_REGION: ap-southeast-2
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      # Use local file storage if no S3 credentials
      USE_LOCAL_STORAGE: ${USE_LOCAL_STORAGE:-true}
      UPLOADS_DIR: /app/uploads
      # Email - use mailhog locally
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      EMAIL_FROM: noreply@familyhelper.local
      # Auth - Kinde (Dev app)
      KINDE_DOMAIN: ${KINDE_DOMAIN:-https://familyhelperapp.kinde.com}
      KINDE_CLIENT_ID: ${KINDE_CLIENT_ID:-552e8d9d29f046418a8dfce0b7f0de1b}
      KINDE_CLIENT_SECRET: ""
      # Stripe (use test keys for dev)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      # API URL for Puppeteer recorder (inside container, so localhost works)
      API_BASE_URL: http://localhost:3000
      # Use local Puppeteer recorder (unified mode)
      USE_LOCAL_RECORDER: "true"
      # Puppeteer Chrome path (in Docker)
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
      # JWT for internal auth
      JWT_SECRET: local-dev-jwt-secret-change-in-production
      MESSAGE_ENCRYPTION_KEY: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
      # CORS - include nginx URL
      CORS_ORIGINS: http://localhost,http://localhost:80,http://localhost:3000,http://localhost:3001,http://localhost:8081
    volumes:
      # Persist uploads
      - ./backend/uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - family-helper-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # PostgreSQL Database (mirrors RDS)
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: family-helper-db
    environment:
      POSTGRES_DB: familyhelper
      POSTGRES_USER: familyhelper_admin
      POSTGRES_PASSWORD: localdev123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U familyhelper_admin -d familyhelper"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - family-helper-network

  # ============================================
  # MailHog (mirrors SES for email testing)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: family-helper-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI - http://localhost:8025
    networks:
      - family-helper-network

  # ============================================
  # pgAdmin (Optional - Database management UI)
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: family-helper-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@familyhelper.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - family-helper-network
    profiles:
      - tools

  # ============================================
  # oauth2-proxy (Edge Authentication - Optional)
  # Phase 2: Validates Kinde JWT tokens at edge
  # ============================================
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: family-helper-oauth2-proxy
    ports:
      - "4180:4180"
    environment:
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_OIDC_ISSUER_URL: https://familyhelperapp.kinde.com
      OAUTH2_PROXY_CLIENT_ID: de8522625a2048fd8b38a5307b20090e
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET:-changeme}
      OAUTH2_PROXY_COOKIE_SECRET: abcdefghijklmnopqrstuvwxyz123456
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_COOKIE_NAME: _oauth2_proxy
      OAUTH2_PROXY_UPSTREAMS: http://api:3000
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_REDIRECT_URL: http://localhost:4180/oauth2/callback
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
      # Phase 2: Enable JWT validation (was "true" which skipped validation)
      OAUTH2_PROXY_SKIP_JWT_BEARER_TOKENS: "false"
      # Only skip auth for public routes (health, webhooks, static assets)
      OAUTH2_PROXY_SKIP_AUTH_ROUTES: "^/health.*|^/public.*|^/webhooks.*|^/auth/.*"
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      # OIDC audience for JWT validation
      OAUTH2_PROXY_OIDC_EXTRA_AUDIENCES: ${KINDE_CLIENT_ID:-552e8d9d29f046418a8dfce0b7f0de1b}
    depends_on:
      - api
    networks:
      - family-helper-network
    profiles:
      - oauth2-proxy

volumes:
  postgres_data:

networks:
  family-helper-network:
    driver: bridge

# =============================================================================
# USAGE
# =============================================================================
#
# RECOMMENDED: Start with nginx (mirrors production):
#   1. Build web-admin:
#      cd web-admin && npm run build
#   2. Start all services:
#      docker-compose up -d
#   3. Access app at: http://localhost
#
# Direct API access (bypass nginx):
#   API is also available at: http://localhost:3000
#
# Start with pgAdmin:
#   docker-compose --profile tools up -d
#
# View logs:
#   docker-compose logs -f nginx
#   docker-compose logs -f api
#
# Rebuild after backend code changes:
#   docker-compose build api && docker-compose up -d api
#
# Rebuild after web-admin changes:
#   cd web-admin && npm run build
#   docker-compose restart nginx
#
# Fresh start (delete data):
#   docker-compose down -v
#
# =============================================================================
# SERVICES
# =============================================================================
#
# | Service       | URL                          | Description                |
# |---------------|------------------------------|----------------------------|
# | nginx         | http://localhost             | Web app + API (like prod)  |
# | API           | http://localhost:3000        | Direct API access          |
# | Postgres      | localhost:5432               | Database                   |
# | MailHog       | http://localhost:8025        | Email testing UI           |
# | pgAdmin       | http://localhost:5050        | Database admin (optional)  |
# | oauth2-proxy  | http://localhost:4180        | Edge auth (optional)       |
#
# =============================================================================
# KINDE CONFIGURATION FOR LOCAL DEV
# =============================================================================
#
# In Kinde dashboard, add these callback URLs for FamilyHelperAPPDev:
#
# Callback URLs:
#   - http://localhost/auth/callback
#   - http://localhost:8081/auth/callback  (for Expo dev server)
#
# Logout Redirect URLs:
#   - http://localhost
#   - http://localhost:8081
#
# =============================================================================
