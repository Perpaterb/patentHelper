# Docker Compose for Local Development
#
# SIMPLIFIED ARCHITECTURE - Mirrors Lightsail Production
#
# Services:
# - api: Unified Express server (API + Recording + Media Processing)
# - postgres: Database (mirrors RDS)
# - mailhog: Email testing (mirrors SES)
# - pgadmin: Optional database management UI

services:
  # ============================================
  # Unified API Server
  # Everything in one container (like Lightsail)
  # ============================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: family-helper-api
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      # Database - use local postgres
      DATABASE_URL: postgresql://familyhelper_admin:localdev123@postgres:5432/familyhelper
      # S3 - use production S3 for file storage (or local for dev)
      S3_BUCKET: ${S3_BUCKET:-family-helper-files-prod}
      AWS_REGION: ap-southeast-2
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      # Use local file storage if no S3 credentials
      USE_LOCAL_STORAGE: ${USE_LOCAL_STORAGE:-true}
      UPLOADS_DIR: /app/uploads
      # Email - use mailhog locally
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      EMAIL_FROM: noreply@familyhelper.local
      # Auth - Kinde
      KINDE_DOMAIN: ${KINDE_DOMAIN:-https://familyhelperapp.kinde.com}
      KINDE_CLIENT_ID: ${KINDE_CLIENT_ID:-552e8d9d29f046418a8dfce0b7f0de1b}
      KINDE_CLIENT_SECRET: ""
      # Stripe (use test keys for dev)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      # API URL for Puppeteer recorder (inside container, so localhost works)
      API_BASE_URL: http://localhost:3000
      # Use local Puppeteer recorder (unified mode)
      USE_LOCAL_RECORDER: "true"
      # Puppeteer Chrome path (in Docker)
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
      # JWT for internal auth
      JWT_SECRET: local-dev-jwt-secret-change-in-production
      MESSAGE_ENCRYPTION_KEY: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
      # CORS - web-admin on 8081, mobile-main on 8082
      CORS_ORIGINS: http://localhost:3000,http://localhost:8081,http://localhost:8082
    volumes:
      # Mount source code for hot reload (optional)
      # - ./backend:/app
      # - /app/node_modules
      # Persist uploads
      - ./backend/uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - family-helper-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # PostgreSQL Database (mirrors RDS)
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: family-helper-db
    environment:
      POSTGRES_DB: familyhelper
      POSTGRES_USER: familyhelper_admin
      POSTGRES_PASSWORD: localdev123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U familyhelper_admin -d familyhelper"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - family-helper-network

  # ============================================
  # MailHog (mirrors SES for email testing)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: family-helper-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI - http://localhost:8025
    networks:
      - family-helper-network

  # ============================================
  # pgAdmin (Optional - Database management UI)
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: family-helper-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@familyhelper.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - family-helper-network
    profiles:
      - tools

volumes:
  postgres_data:

networks:
  family-helper-network:
    driver: bridge

# =============================================================================
# USAGE
# =============================================================================
#
# Start everything:
#   docker-compose up -d
#
# Start with pgAdmin:
#   docker-compose --profile tools up -d
#
# View logs:
#   docker-compose logs -f api
#
# Rebuild after code changes:
#   docker-compose build api && docker-compose up -d api
#
# Fresh start (delete data):
#   docker-compose down -v
#
# =============================================================================
# SERVICES
# =============================================================================
#
# | Service   | URL                          | Description                |
# |-----------|------------------------------|----------------------------|
# | API       | http://localhost:3000        | Unified backend server     |
# | Postgres  | localhost:5432               | Database                   |
# | MailHog   | http://localhost:8025        | Email testing UI           |
# | pgAdmin   | http://localhost:5050        | Database admin (optional)  |
#
# =============================================================================
