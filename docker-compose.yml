# Docker Compose for Local Development
#
# SIMPLIFIED ARCHITECTURE - Mirrors Lightsail Production
#
# Services:
# - oauth2-proxy: Edge authentication (blocks unauthorized requests)
# - api: Unified Express server (API + Recording + Media Processing)
# - postgres: Database (mirrors RDS)
# - mailhog: Email testing (mirrors SES)
# - pgadmin: Optional database management UI

services:
  # ============================================
  # oauth2-proxy (Edge Authentication)
  # Blocks unauthorized requests BEFORE reaching API
  # ============================================
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: family-helper-oauth2-proxy
    ports:
      - "4180:4180"
    environment:
      # Kinde OIDC Configuration
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_OIDC_ISSUER_URL: https://familyhelperapp.kinde.com
      OAUTH2_PROXY_CLIENT_ID: ${KINDE_CLIENT_ID:-552e8d9d29f046418a8dfce0b7f0de1b}
      OAUTH2_PROXY_CLIENT_SECRET: ${KINDE_CLIENT_SECRET}

      # Cookie configuration
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET:-0123456789abcdef0123456789abcdef}
      OAUTH2_PROXY_COOKIE_SECURE: "false"  # Allow HTTP for local dev
      OAUTH2_PROXY_COOKIE_NAME: _oauth2_proxy

      # Upstream (Express API)
      OAUTH2_PROXY_UPSTREAMS: http://api:3000
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180

      # Redirect URL (local dev)
      OAUTH2_PROXY_REDIRECT_URL: http://localhost:4180/oauth2/callback

      # Allow all email domains
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"

      # Pass auth info to upstream
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
      OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "true"

      # JWT passthrough for mobile apps
      OAUTH2_PROXY_SKIP_JWT_BEARER_TOKENS: "true"

      # Skip auth for public routes
      OAUTH2_PROXY_SKIP_AUTH_ROUTES: "^/health.*,^/public.*,^/webhooks.*,^/auth.*,^/.*\\.(js|css|png|jpg|svg|ico|woff2?)$$"

      # Reverse proxy mode
      OAUTH2_PROXY_REVERSE_PROXY: "true"
    depends_on:
      - api
    networks:
      - family-helper-network
    profiles:
      - oauth2-proxy  # Only start with: docker-compose --profile oauth2-proxy up

  # ============================================
  # Unified API Server
  # Everything in one container (like Lightsail)
  # ============================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: family-helper-api
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      # Database - use local postgres
      DATABASE_URL: postgresql://familyhelper_admin:localdev123@postgres:5432/familyhelper
      # S3 - use production S3 for file storage (or local for dev)
      S3_BUCKET: ${S3_BUCKET:-family-helper-files-prod}
      AWS_REGION: ap-southeast-2
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      # Use local file storage if no S3 credentials
      USE_LOCAL_STORAGE: ${USE_LOCAL_STORAGE:-true}
      UPLOADS_DIR: /app/uploads
      # Email - use mailhog locally
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      EMAIL_FROM: noreply@familyhelper.local
      # Auth - Kinde
      KINDE_DOMAIN: ${KINDE_DOMAIN:-https://familyhelperapp.kinde.com}
      KINDE_CLIENT_ID: ${KINDE_CLIENT_ID:-552e8d9d29f046418a8dfce0b7f0de1b}
      KINDE_CLIENT_SECRET: ""
      # Stripe (use test keys for dev)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      # API URL for Puppeteer recorder (inside container, so localhost works)
      API_BASE_URL: http://localhost:3000
      # Use local Puppeteer recorder (unified mode)
      USE_LOCAL_RECORDER: "true"
      # Puppeteer Chrome path (in Docker)
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
      # JWT for internal auth
      JWT_SECRET: local-dev-jwt-secret-change-in-production
      MESSAGE_ENCRYPTION_KEY: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
      # CORS
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:8081
    volumes:
      # Mount source code for hot reload (optional)
      # - ./backend:/app
      # - /app/node_modules
      # Persist uploads
      - ./backend/uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - family-helper-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # PostgreSQL Database (mirrors RDS)
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: family-helper-db
    environment:
      POSTGRES_DB: familyhelper
      POSTGRES_USER: familyhelper_admin
      POSTGRES_PASSWORD: localdev123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U familyhelper_admin -d familyhelper"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - family-helper-network

  # ============================================
  # MailHog (mirrors SES for email testing)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: family-helper-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI - http://localhost:8025
    networks:
      - family-helper-network

  # ============================================
  # pgAdmin (Optional - Database management UI)
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: family-helper-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@familyhelper.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - family-helper-network
    profiles:
      - tools

volumes:
  postgres_data:

networks:
  family-helper-network:
    driver: bridge

# =============================================================================
# USAGE
# =============================================================================
#
# Start everything (without oauth2-proxy):
#   docker-compose up -d
#
# Start with oauth2-proxy (edge auth testing):
#   docker-compose --profile oauth2-proxy up -d
#   NOTE: Requires KINDE_CLIENT_SECRET env var
#
# Start with pgAdmin:
#   docker-compose --profile tools up -d
#
# View logs:
#   docker-compose logs -f api
#   docker-compose logs -f oauth2-proxy
#
# Rebuild after code changes:
#   docker-compose build api && docker-compose up -d api
#
# Fresh start (delete data):
#   docker-compose down -v
#
# =============================================================================
# SERVICES
# =============================================================================
#
# | Service       | URL                          | Description                |
# |---------------|------------------------------|----------------------------|
# | oauth2-proxy  | http://localhost:4180        | Edge auth (optional)       |
# | API           | http://localhost:3000        | Unified backend server     |
# | Postgres      | localhost:5432               | Database                   |
# | MailHog       | http://localhost:8025        | Email testing UI           |
# | pgAdmin       | http://localhost:5050        | Database admin (optional)  |
#
# =============================================================================
# OAUTH2-PROXY TESTING
# =============================================================================
#
# To test oauth2-proxy locally:
#
# 1. Get Kinde Client Secret from Kinde dashboard
# 2. Add callback URL in Kinde: http://localhost:4180/oauth2/callback
# 3. Set environment variables:
#    export KINDE_CLIENT_SECRET="your-client-secret"
#    export OAUTH2_PROXY_COOKIE_SECRET=$(openssl rand -base64 32 | tr -d '\n')
#
# 4. Start with oauth2-proxy profile:
#    docker-compose --profile oauth2-proxy up -d
#
# 5. Access API through oauth2-proxy:
#    curl http://localhost:4180/health  # Should work (public route)
#    curl http://localhost:4180/groups  # Redirects to Kinde login
#
# 6. Mobile app testing (JWT passthrough):
#    curl -H "Authorization: Bearer <jwt_token>" http://localhost:4180/groups
#
# =============================================================================
