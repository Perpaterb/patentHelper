# Docker Compose for Local Development
# Mirrors production AWS infrastructure for consistent development experience
#
# Services:
# - postgres: RDS PostgreSQL equivalent
# - mailhog: SES email testing equivalent
# - media-processor: ECR Lambda equivalent (ffmpeg, sharp, PDF)
# - pgadmin: Optional database management UI (--profile tools)

services:
  # ============================================
  # PostgreSQL Database (mirrors RDS)
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: family-helper-db
    environment:
      POSTGRES_DB: familyhelper
      POSTGRES_USER: familyhelper_admin
      POSTGRES_PASSWORD: localdev123
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U familyhelper_admin -d familyhelper"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - family-helper-network

  # ============================================
  # MailHog (mirrors SES for email testing)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: family-helper-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    networks:
      - family-helper-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # Media Processor (mirrors ECR Lambda)
  # Handles: video/audio conversion (ffmpeg), image conversion (sharp), PDF generation,
  # and call recording (puppeteer with headless Chrome)
  # ============================================
  media-processor:
    build:
      context: ./backend/media-processor
      dockerfile: Dockerfile
    container_name: fh-media-video-audio-image-pdf-recorder
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      # Local file storage (shared with backend)
      UPLOADS_DIR: /app/uploads
      # WSL2: Docker host URL for Puppeteer to reach the backend
      # In WSL2, host.docker.internal doesn't work reliably, so we use the WSL IP
      # Run: ip addr show eth0 | grep "inet " | awk '{print $2}' | cut -d/ -f1
      # Or set DOCKER_HOST_URL in your shell before docker-compose up
      DOCKER_HOST_URL: ${DOCKER_HOST_URL:-host.docker.internal}
    volumes:
      # Share uploads directory with backend
      - ./backend/uploads:/app/uploads
    # Allow container to access host machine (for Puppeteer to reach backend at localhost:3000)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - family-helper-network
    depends_on:
      - postgres

  # ============================================
  # pgAdmin (Optional - Database management UI)
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: family-helper-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@familyhelper.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - family-helper-network
    profiles:
      - tools  # Only starts with: docker-compose --profile tools up

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  family-helper-network:
    driver: bridge

# =============================================================================
# USAGE INSTRUCTIONS
# =============================================================================
#
# Start all services (recommended for development):
#   docker-compose up -d
#
# Start with pgAdmin for database management:
#   docker-compose --profile tools up -d
#
# Stop services:
#   docker-compose down
#
# Stop and remove data (fresh start):
#   docker-compose down -v
#
# View logs:
#   docker-compose logs -f postgres
#   docker-compose logs -f media-processor
#   docker-compose logs -f mailhog
#
# Rebuild media-processor after changes:
#   docker-compose build media-processor
#   docker-compose up -d media-processor
#
# =============================================================================
# LOCAL SERVICES OVERVIEW
# =============================================================================
#
# | Service          | Local URL                    | Production Equivalent      |
# |------------------|------------------------------|----------------------------|
# | PostgreSQL       | localhost:5432               | RDS PostgreSQL             |
# | MailHog SMTP     | localhost:1025               | AWS SES                    |
# | MailHog Web UI   | http://localhost:8025        | -                          |
# | Media Processor  | http://localhost:3001        | ECR Lambda (container)     |
# | pgAdmin          | http://localhost:5050        | -                          |
# | Backend API      | http://localhost:3000        | API Gateway + Lambda (zip) |
# | Web Admin        | http://localhost:8081        | CloudFront + S3            |
# | Mobile Main      | Expo DevTools                | App Store / Play Store     |
#
# =============================================================================
# ENVIRONMENT VARIABLES FOR backend/.env
# =============================================================================
#
# DATABASE_URL=postgresql://familyhelper_admin:localdev123@localhost:5432/familyhelper
# SMTP_HOST=localhost
# SMTP_PORT=1025
# MEDIA_PROCESSOR_URL=http://localhost:3001
#
# =============================================================================
