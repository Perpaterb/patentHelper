# CI/CD Pipeline for Family Helper App
#
# STATUS: DISABLED - To enable, change the trigger from workflow_dispatch to push
#
# NOTE: Production is now on LIGHTSAIL, not Lambda/CloudFront!
# This workflow is outdated. For manual deployment use:
#   ./scripts/deploy-lightsail.sh        # Full backend + frontend
#   ./scripts/deploy-web-frontend.sh     # Frontend only
#
# This workflow handles:
# - Testing backend, web-admin, and mobile-main
# - (OUTDATED) Building and deploying Lambda API to AWS
# - (OUTDATED) Building and deploying web-admin to CloudFront/S3
#
# To enable automatic deployment on push to main:
# 1. Uncomment the 'push' trigger below
# 2. Comment out 'workflow_dispatch'
#
# Manual deployment:
# - Go to Actions tab in GitHub
# - Select "CI/CD Pipeline"
# - Click "Run workflow"

name: CI/CD Pipeline

on:
  # DISABLED: Uncomment below to enable automatic deployment on push to main
  # push:
  #   branches: [main]

  # Manual trigger only (workflow is disabled for automatic runs)
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend Lambda'
        required: false
        default: 'true'
        type: boolean
      deploy_web:
        description: 'Deploy Web Admin'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '20'
  AWS_REGION: 'ap-southeast-2'
  LAMBDA_FUNCTION_NAME: 'family-helper-api-prod'
  S3_LAMBDA_BUCKET: 'family-helper-files-prod'
  S3_WEB_BUCKET: 'family-helper-web-prod'
  CLOUDFRONT_DISTRIBUTION_ID: 'EOFB5YCW926IM'

jobs:
  # ============================================
  # TEST PHASE - Runs in parallel
  # ============================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run linter
        working-directory: backend
        run: npm run lint --if-present

      - name: Run tests
        working-directory: backend
        run: npm test --if-present
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          JWT_SECRET: "test-secret"
          KINDE_DOMAIN: "https://test.kinde.com"
          KINDE_CLIENT_ID: "test-client-id"

  test-web-admin:
    name: Test Web Admin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web-admin/package-lock.json

      - name: Install dependencies
        working-directory: web-admin
        run: npm install --legacy-peer-deps

      - name: Run tests
        working-directory: web-admin
        run: npm test --if-present -- --passWithNoTests
        env:
          CI: true

  test-mobile-main:
    name: Test Mobile Main
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile-main/package-lock.json

      - name: Install dependencies
        working-directory: mobile-main
        run: npm install --legacy-peer-deps

      - name: Run tests
        working-directory: mobile-main
        run: npm test --if-present -- --passWithNoTests
        env:
          CI: true

  # ============================================
  # DEPLOY BACKEND - Lambda API
  # ============================================
  deploy-backend:
    name: Deploy Backend Lambda
    runs-on: ubuntu-latest
    needs: [test-backend, test-web-admin, test-mobile-main]
    if: ${{ github.event.inputs.deploy_backend != 'false' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Lambda package
        working-directory: backend
        run: |
          echo "üèóÔ∏è  Building Lambda deployment package..."

          # Clean up any existing build
          rm -rf lambda-build lambda.zip

          # Create build directory
          mkdir -p lambda-build

          # Copy necessary files
          echo "üì¶ Copying files..."
          cp -r controllers lambda-build/
          cp -r routes lambda-build/
          cp -r services lambda-build/
          cp -r middleware lambda-build/
          cp -r config lambda-build/
          cp -r prisma lambda-build/
          cp -r utils lambda-build/ 2>/dev/null || true
          cp server.js lambda-build/
          cp lambda.js lambda-build/
          cp package.json lambda-build/
          cp package-lock.json lambda-build/

          # Copy public folder if it exists
          if [ -d "public" ]; then
            cp -r public lambda-build/
          fi

          # Install production dependencies only
          echo "üì• Installing production dependencies..."
          cd lambda-build
          npm ci --omit=dev

          # Generate Prisma client
          echo "üóÑÔ∏è  Generating Prisma client..."
          npx prisma generate

          # Remove unnecessary files to reduce package size
          echo "üßπ Cleaning up unnecessary files..."

          # Remove media processing packages (handled by Worker Service)
          rm -rf node_modules/fluent-ffmpeg 2>/dev/null || true
          rm -rf node_modules/@ffmpeg-installer 2>/dev/null || true
          rm -rf node_modules/@ffprobe-installer 2>/dev/null || true

          # Remove sharp and image processing (handled by Worker Service)
          rm -rf node_modules/sharp 2>/dev/null || true
          rm -rf node_modules/@img 2>/dev/null || true
          rm -rf node_modules/heic-convert 2>/dev/null || true
          rm -rf node_modules/libheif-js 2>/dev/null || true

          # Remove non-Lambda Prisma engine binaries (keep only rhel for Lambda)
          find node_modules -type f -name "libquery_engine-*" ! -name "*rhel*" -delete 2>/dev/null || true
          find node_modules/@prisma -name "*darwin*" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules/@prisma -name "*windows*" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules/@prisma -name "*debian*" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules/@prisma -name "*linux-musl*" -type d -exec rm -rf {} + 2>/dev/null || true

          # Remove dev packages that may have slipped through
          rm -rf node_modules/typescript 2>/dev/null || true
          rm -rf node_modules/effect 2>/dev/null || true
          rm -rf node_modules/eslint 2>/dev/null || true
          rm -rf node_modules/fast-check 2>/dev/null || true
          rm -rf node_modules/@types 2>/dev/null || true
          rm -rf node_modules/core-js 2>/dev/null || true

          # Remove TypeScript and documentation files
          find node_modules -name "*.ts" ! -name "*.d.ts" -delete 2>/dev/null || true
          find node_modules -name "*.map" -delete 2>/dev/null || true
          find node_modules -name "README*" -delete 2>/dev/null || true
          find node_modules -name "CHANGELOG*" -delete 2>/dev/null || true
          find node_modules -name "*.md" -delete 2>/dev/null || true
          find node_modules -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "example" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true

          # Show node_modules size after cleanup
          echo "üìä node_modules size after cleanup:"
          du -sh node_modules

          # Create zip file
          echo "üì¶ Creating zip file..."
          zip -r ../lambda.zip . -x "*.git*" -x "*__tests__*" -x "*.test.js" -x "*.spec.js"

          cd ..
          rm -rf lambda-build

          # Show final size
          ZIP_SIZE=$(ls -lh lambda.zip | awk '{print $5}')
          UNZIP_SIZE=$(unzip -l lambda.zip | tail -1 | awk '{print $1}')
          UNZIP_MB=$(echo "scale=2; $UNZIP_SIZE / 1048576" | bc)
          echo "‚úÖ Lambda package built: ${ZIP_SIZE} compressed, ${UNZIP_MB} MB uncompressed"

          # Check Lambda size limit (250MB)
          if [ "$UNZIP_SIZE" -gt 262144000 ]; then
            echo "‚ùå ERROR: Package exceeds 250MB Lambda limit!"
            exit 1
          fi

      - name: Upload Lambda to S3
        working-directory: backend
        run: |
          echo "‚¨ÜÔ∏è  Uploading Lambda package to S3..."
          aws s3 cp lambda.zip s3://${{ env.S3_LAMBDA_BUCKET }}/lambda/lambda.zip

      - name: Update Lambda function
        run: |
          echo "üîÑ Updating Lambda function..."
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --s3-bucket ${{ env.S3_LAMBDA_BUCKET }} \
            --s3-key lambda/lambda.zip

          echo "‚è≥ Waiting for Lambda update to complete..."
          aws lambda wait function-updated --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
          echo "‚úÖ Lambda function updated successfully!"

      - name: Verify Lambda health
        run: |
          echo "üè• Checking Lambda health..."
          sleep 5
          HEALTH_RESPONSE=$(curl -s https://i5i7f82usg.execute-api.ap-southeast-2.amazonaws.com/prod/health)
          echo "Health response: $HEALTH_RESPONSE"

          if echo "$HEALTH_RESPONSE" | grep -q '"status":"healthy"'; then
            echo "‚úÖ Lambda is healthy!"
          else
            echo "‚ö†Ô∏è  Lambda health check returned unexpected response"
            exit 1
          fi

  # ============================================
  # DEPLOY WEB ADMIN - CloudFront/S3
  # ============================================
  deploy-web-admin:
    name: Deploy Web Admin
    runs-on: ubuntu-latest
    needs: [test-backend, test-web-admin, test-mobile-main]
    if: ${{ github.event.inputs.deploy_web != 'false' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web-admin/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        working-directory: web-admin
        run: npm install --legacy-peer-deps

      - name: Build web app
        working-directory: web-admin
        run: npx expo export --platform web
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          EXPO_PUBLIC_API_URL: "https://i5i7f82usg.execute-api.ap-southeast-2.amazonaws.com/prod"
          EXPO_PUBLIC_KINDE_DOMAIN: "https://familyhelperapp.kinde.com"
          EXPO_PUBLIC_KINDE_CLIENT_ID: "bfbf86777e654654b374cf92f5719c74"
          EXPO_PUBLIC_KINDE_REDIRECT_URI: "https://familyhelperapp.com/auth/callback"
          EXPO_PUBLIC_KINDE_LOGOUT_REDIRECT_URI: "https://familyhelperapp.com"
          EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}

      - name: Deploy to S3
        working-directory: web-admin
        run: |
          echo "‚¨ÜÔ∏è  Uploading web app to S3..."
          aws s3 sync dist/ s3://${{ env.S3_WEB_BUCKET }}/ --delete
          echo "‚úÖ S3 upload complete!"

      - name: Invalidate CloudFront cache
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "Invalidation ID: $INVALIDATION_ID"
          echo "‚è≥ Waiting for CloudFront invalidation to complete..."

          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id $INVALIDATION_ID

          echo "‚úÖ CloudFront cache invalidated!"

      - name: Verify web deployment
        run: |
          echo "üåê Verifying web deployment..."
          sleep 5
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://familyhelperapp.com)

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Web app is accessible (HTTP $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è  Web app returned HTTP $HTTP_STATUS"
            exit 1
          fi

  # ============================================
  # DEPLOYMENT SUMMARY
  # ============================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-web-admin]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "=========================================="
          echo "DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "Backend Lambda: ${{ needs.deploy-backend.result }}"
          echo "Web Admin:      ${{ needs.deploy-web-admin.result }}"
          echo ""
          echo "Production URLs:"
          echo "  - Web App: https://familyhelperapp.com"
          echo "  - API:     https://i5i7f82usg.execute-api.ap-southeast-2.amazonaws.com/prod"
          echo ""
          echo "=========================================="
