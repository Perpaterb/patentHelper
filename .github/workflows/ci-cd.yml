# CI/CD Pipeline for Family Helper App
#
# ARCHITECTURE: Lightsail-based deployment
# - Backend: Express.js on Ubuntu Lightsail with PM2
# - Frontend: Static files served by Nginx on same Lightsail instance
# - Database: AWS RDS PostgreSQL
# - Storage: AWS S3
#
# TRIGGERS:
# - Push to main: Full test + deploy pipeline
# - Pull requests: Tests only (via pr-checks.yml)
# - Manual: workflow_dispatch with options

name: CI/CD Pipeline

on:
  # DISABLED: Automatic deployment on push to main
  # Uncomment below to re-enable
  # push:
  #   branches: [main]

  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        required: false
        default: true
        type: boolean
      deploy_web:
        description: 'Deploy Web Admin'
        required: false
        default: true
        type: boolean
      skip_tests:
        description: 'Skip Tests (emergency deploy)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  LIGHTSAIL_IP: '52.65.37.116'
  APP_DIR: '/home/ubuntu/family-helper'
  WEB_DIR: '/home/ubuntu/web-admin'

jobs:
  # ============================================
  # TEST PHASE - Runs in parallel
  # ============================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run linter
        working-directory: backend
        run: npm run lint --if-present

      - name: Run tests
        working-directory: backend
        run: npm test --if-present
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          JWT_SECRET: "test-secret"
          KINDE_DOMAIN: "https://test.kinde.com"
          KINDE_CLIENT_ID: "test-client-id"

  test-web-admin:
    name: Test Web Admin
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web-admin/package-lock.json

      - name: Install dependencies
        working-directory: web-admin
        run: npm install --legacy-peer-deps

      - name: Run tests
        working-directory: web-admin
        run: npm test --if-present -- --passWithNoTests
        env:
          CI: true

  test-mobile-main:
    name: Test Mobile Main
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile-main/package-lock.json

      - name: Install dependencies
        working-directory: mobile-main
        run: npm install --legacy-peer-deps

      - name: Run tests
        working-directory: mobile-main
        run: npm test --if-present -- --passWithNoTests
        env:
          CI: true

  # ============================================
  # DEPLOY BACKEND - Lightsail
  # ============================================
  deploy-backend:
    name: Deploy Backend to Lightsail
    runs-on: ubuntu-latest
    needs: [test-backend, test-web-admin, test-mobile-main]
    if: |
      always() &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped') &&
      (needs.test-web-admin.result == 'success' || needs.test-web-admin.result == 'skipped') &&
      (needs.test-mobile-main.result == 'success' || needs.test-mobile-main.result == 'skipped') &&
      (github.event.inputs.deploy_backend != 'false')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail.pem
          chmod 600 ~/.ssh/lightsail.pem
          ssh-keyscan -H ${{ env.LIGHTSAIL_IP }} >> ~/.ssh/known_hosts

      - name: Deploy backend files
        run: |
          echo "ðŸ“¦ Syncing backend files to Lightsail..."
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude 'uploads' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude '*.log' \
            --exclude 'coverage' \
            --exclude '__tests__' \
            --exclude '.git' \
            -e "ssh -i ~/.ssh/lightsail.pem" \
            ./backend/ ubuntu@${{ env.LIGHTSAIL_IP }}:${{ env.APP_DIR }}/

      - name: Install dependencies and restart
        run: |
          echo "ðŸ”§ Installing dependencies and restarting..."
          ssh -i ~/.ssh/lightsail.pem ubuntu@${{ env.LIGHTSAIL_IP }} << 'EOF'
          cd /home/ubuntu/family-helper

          # Install production dependencies
          npm ci --omit=dev

          # Generate Prisma client
          npx prisma generate

          # Run database migrations
          npx prisma migrate deploy

          # Restart the app with PM2
          pm2 restart family-helper || pm2 start server.js --name family-helper

          # Save PM2 config
          pm2 save

          # Show status
          pm2 status
          EOF

      - name: Verify backend health
        run: |
          echo "ðŸ¥ Checking backend health..."
          sleep 5
          HEALTH_RESPONSE=$(curl -s https://familyhelperapp.com/health)
          echo "Health response: $HEALTH_RESPONSE"

          if echo "$HEALTH_RESPONSE" | grep -q '"status":"healthy"'; then
            echo "âœ… Backend is healthy!"
          else
            echo "âš ï¸  Backend health check returned unexpected response"
            exit 1
          fi

  # ============================================
  # DEPLOY WEB ADMIN - Lightsail
  # ============================================
  deploy-web-admin:
    name: Deploy Web Admin to Lightsail
    runs-on: ubuntu-latest
    needs: [test-backend, test-web-admin, test-mobile-main]
    if: |
      always() &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped') &&
      (needs.test-web-admin.result == 'success' || needs.test-web-admin.result == 'skipped') &&
      (needs.test-mobile-main.result == 'success' || needs.test-mobile-main.result == 'skipped') &&
      (github.event.inputs.deploy_web != 'false')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web-admin/package-lock.json

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail.pem
          chmod 600 ~/.ssh/lightsail.pem
          ssh-keyscan -H ${{ env.LIGHTSAIL_IP }} >> ~/.ssh/known_hosts

      - name: Install dependencies
        working-directory: web-admin
        run: npm install --legacy-peer-deps

      - name: Build web app
        working-directory: web-admin
        run: npx expo export --platform web
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          EXPO_PUBLIC_API_URL: "https://familyhelperapp.com"
          EXPO_PUBLIC_KINDE_DOMAIN: "https://familyhelperapp.kinde.com"
          EXPO_PUBLIC_KINDE_CLIENT_ID: "bfbf86777e654654b374cf92f5719c74"
          EXPO_PUBLIC_KINDE_REDIRECT_URI: "https://familyhelperapp.com/auth/callback"
          EXPO_PUBLIC_KINDE_LOGOUT_REDIRECT_URI: "https://familyhelperapp.com"
          EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}

      - name: Deploy web app
        working-directory: web-admin
        run: |
          echo "ðŸ“¦ Syncing web app to Lightsail..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/lightsail.pem" \
            ./dist/ ubuntu@${{ env.LIGHTSAIL_IP }}:${{ env.WEB_DIR }}/

      - name: Verify web deployment
        run: |
          echo "ðŸŒ Verifying web deployment..."
          sleep 3
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://familyhelperapp.com)

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Web app is accessible (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸  Web app returned HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Get deployed bundle version
        run: |
          echo "ðŸ“¦ Checking deployed bundle version..."
          DEPLOYED_BUNDLE=$(ssh -i ~/.ssh/lightsail.pem ubuntu@${{ env.LIGHTSAIL_IP }} \
            "grep -o 'index-[a-f0-9]*\.js' /home/ubuntu/web-admin/index.html | head -1")
          echo "âœ… Deployed bundle: $DEPLOYED_BUNDLE"
          echo "DEPLOYED_BUNDLE=$DEPLOYED_BUNDLE" >> $GITHUB_OUTPUT

  # ============================================
  # DEPLOYMENT SUMMARY
  # ============================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-web-admin]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "=========================================="
          echo "DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "Commit:   ${{ github.sha }}"
          echo "Branch:   ${{ github.ref_name }}"
          echo "Actor:    ${{ github.actor }}"
          echo ""
          echo "Backend:  ${{ needs.deploy-backend.result }}"
          echo "Web App:  ${{ needs.deploy-web-admin.result }}"
          echo ""
          echo "Production URL: https://familyhelperapp.com"
          echo "Health Check:   https://familyhelperapp.com/health"
          echo ""
          echo "=========================================="
