# oauth2-proxy Configuration for Family Helper
# Documentation: https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview

# =============================================================================
# PROVIDER CONFIGURATION (Kinde OIDC)
# =============================================================================

provider = "oidc"
provider_display_name = "Kinde"

# Kinde OIDC endpoints
oidc_issuer_url = "https://familyhelperapp.kinde.com"

# Client credentials (set via environment variables for security)
# client_id = set via OAUTH2_PROXY_CLIENT_ID env var
# client_secret = set via OAUTH2_PROXY_CLIENT_SECRET env var

# =============================================================================
# UPSTREAM CONFIGURATION
# =============================================================================

# Forward authenticated requests to Express API
upstreams = [
    "http://127.0.0.1:3000"
]

# =============================================================================
# SERVER CONFIGURATION
# =============================================================================

# Listen on port 4180
http_address = "0.0.0.0:4180"

# =============================================================================
# COOKIE CONFIGURATION
# =============================================================================

# Cookie settings
cookie_name = "_oauth2_proxy"
cookie_secure = true
cookie_httponly = true
cookie_samesite = "lax"

# Cookie secret (32 bytes, set via environment variable)
# cookie_secret = set via OAUTH2_PROXY_COOKIE_SECRET env var

# Cookie domain (allow subdomains)
cookie_domains = [".familyhelperapp.com"]

# Session expiry (24 hours)
cookie_expire = "24h"

# Refresh tokens before expiry
cookie_refresh = "1h"

# =============================================================================
# AUTHENTICATION BEHAVIOR
# =============================================================================

# Redirect URL after authentication
redirect_url = "https://familyhelperapp.com/oauth2/callback"

# Allow all email domains (Kinde handles user management)
email_domains = ["*"]

# Pass user info headers to upstream
set_xauthrequest = true
pass_access_token = true
pass_authorization_header = true

# Headers to set on upstream requests
set_authorization_header = true

# =============================================================================
# SKIP AUTH ROUTES (PUBLIC ENDPOINTS)
# =============================================================================

# These routes bypass oauth2-proxy authentication
# Express handles its own auth for these (or they're truly public)
skip_auth_routes = [
    # Health checks
    "^/health$",
    "^/health/.*",

    # Public pages served by web app
    "^/$",
    "^/index\\.html$",
    "^/assets/.*",
    "^/favicon\\.ico$",

    # Public API endpoints
    "^/public/.*",

    # Stripe webhooks (have their own signature verification)
    "^/webhooks/stripe$",

    # Auth endpoints (Kinde handles auth)
    "^/auth/.*",

    # Static files
    "^/.*\\.js$",
    "^/.*\\.css$",
    "^/.*\\.png$",
    "^/.*\\.jpg$",
    "^/.*\\.svg$",
    "^/.*\\.woff2?$",
    "^/.*\\.ttf$"
]

# =============================================================================
# JWT / BEARER TOKEN PASSTHROUGH (FOR MOBILE APPS)
# =============================================================================

# CRITICAL: Allow requests with valid Bearer tokens to pass through
# Mobile apps send: Authorization: Bearer <jwt_token>
# oauth2-proxy should validate and pass through, not require session cookie
skip_jwt_bearer_tokens = true

# =============================================================================
# SIMPLE BLOCKING MODE (CURRENT)
# =============================================================================
# NOTE: Currently skipping ALL routes because oauth2-proxy cannot validate
# the API's custom JWTs (different issuer). API handles its own auth.
# FUTURE: Migrate to Kinde tokens directly for full edge validation.
#
# To enable full validation, remove this line and ensure mobile apps
# send Kinde tokens directly (not custom JWTs).
skip_auth_regex = ["^/.*"]

# =============================================================================
# LOGGING
# =============================================================================

# Standard logging to stdout/stderr
logging_filename = ""
logging_max_size = 0
logging_max_age = 0
logging_local_time = true
logging_compress = false

# Request logging
request_logging = true
request_logging_format = "{{.Client}} - {{.Username}} [{{.Timestamp}}] {{.Host}} {{.RequestMethod}} {{.Upstream}} {{.RequestURI}} {{.Protocol}} {{.UserAgent}} {{.StatusCode}} {{.ResponseSize}} {{.RequestDuration}}"

# =============================================================================
# SECURITY
# =============================================================================

# Reverse proxy mode (trust X-Forwarded-* headers from Nginx)
reverse_proxy = true

# Real IP header (from Nginx)
real_client_ip_header = "X-Real-IP"
