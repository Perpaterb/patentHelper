generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId                String    @id @default(uuid()) @map("user_id") @db.Uuid
  email                 String    @unique @db.VarChar(255)
  kindeId               String    @unique @map("kinde_id") @db.VarChar(255)
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  isSubscribed          Boolean   @default(false) @map("is_subscribed")
  subscriptionId        String?   @map("subscription_id") @db.VarChar(255)
  subscriptionStartDate DateTime? @map("subscription_start_date") @db.Timestamp(6)
  subscriptionEndDate   DateTime? @map("subscription_end_date") @db.Timestamp(6)
  storageLimitGb        Int       @default(0) @map("storage_limit_gb")
  storageUsedBytes      BigInt    @default(0) @map("storage_used_bytes")
  lastLogin             DateTime? @map("last_login") @db.Timestamp(6)
  displayName           String?   @map("display_name") @db.VarChar(255)
  memberIcon            String?   @map("member_icon") @db.VarChar(10)
  iconColor             String?   @map("icon_color") @db.VarChar(7)
  profilePhotoFileId    String?   @map("profile_photo_file_id") @db.Uuid

  // Support and account status flags
  isSupportUser Boolean   @default(false) @map("is_support_user")
  isLocked      Boolean   @default(false) @map("is_locked")
  lockedAt      DateTime? @map("locked_at") @db.Timestamp(6)
  lockedReason  String?   @map("locked_reason") @db.VarChar(500)

  // Stripe billing fields (Option B - manual billing)
  stripeCustomerId        String?   @unique @map("stripe_customer_id") @db.VarChar(255)
  defaultPaymentMethodId  String?   @map("default_payment_method_id") @db.VarChar(255)
  renewalDate             DateTime? @map("renewal_date") @db.Timestamp(6)
  additionalStoragePacks  Int       @default(0) @map("additional_storage_packs")
  lastBillingAttempt      DateTime? @map("last_billing_attempt") @db.Timestamp(6)
  billingFailureCount     Int       @default(0) @map("billing_failure_count")
  lastBillingReminderSent DateTime? @map("last_billing_reminder_sent") @db.Timestamp(6)

  groupMemberships        GroupMember[]
  createdGroups           Group[]                @relation("GroupCreator")
  pinnedItems             PinnedItem[]
  storageUsage            StorageUsage[]
  personalGiftRegistries  PersonalGiftRegistry[] @relation("PersonalGiftRegistries")
  personalItemRegistries  PersonalItemRegistry[] @relation("PersonalItemRegistries")
  billingHistory          BillingHistory[]
  supportActionsPerformed SupportAuditLog[]      @relation("SupportActionPerformer")
  supportActionsReceived  SupportAuditLog[]      @relation("SupportActionTarget")

  @@index([email])
  @@index([kindeId])
  @@index([renewalDate])
  @@index([isSupportUser])
  @@map("users")
}

model Group {
  groupId                   String                          @id @default(uuid()) @map("group_id") @db.Uuid
  name                      String                          @db.VarChar(255)
  icon                      String?                         @db.VarChar(255)
  backgroundImageId         String?                         @map("background_image_id") @db.Uuid
  backgroundColor           String?                         @map("background_color") @db.VarChar(7)
  createdAt                 DateTime                        @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                 DateTime                        @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  isHidden                  Boolean                         @default(false) @map("is_hidden")
  dateFormat                String                          @default("MM/DD/YYYY") @map("date_format") @db.VarChar(50)
  currency                  String                          @default("USD") @db.VarChar(3)
  createdByTrialUser        Boolean                         @default(false) @map("created_by_trial_user")
  createdByUserId           String?                         @map("created_by_user_id") @db.Uuid
  readOnlyUntil             DateTime?                       @map("read_only_until") @db.Timestamp(6)
  adminPermissions          AdminPermission[]
  approvals                 Approval[]
  auditLogs                 AuditLog[]
  calendarEvents            CalendarEvent[]
  financeMatters            FinanceMatter[]
  members                   GroupMember[]
  settings                  GroupSettings?
  createdBy                 User?                           @relation("GroupCreator", fields: [createdByUserId], references: [userId])
  messageGroups             MessageGroup[]
  relationships             Relationship[]
  storageUsage              StorageUsage[]
  wishLists                 WishList[]
  krisKringles              KrisKringle[]
  giftRegistries            GiftRegistry[]
  personalGiftRegistryLinks PersonalGiftRegistryGroupLink[] @relation("PersonalGiftRegistryLinks")
  personalItemRegistryLinks PersonalItemRegistryGroupLink[] @relation("PersonalItemRegistryLinks")
  itemRegistries            ItemRegistry[]                  @relation("ItemRegistries")
  wikiDocuments             WikiDocument[]
  groupDocuments            GroupDocument[]
  logExports                LogExport[]
  phoneCalls                PhoneCall[]
  videoCalls                VideoCall[]

  @@index([createdAt])
  @@map("groups")
}

model GroupMember {
  groupMemberId              String                          @id @default(uuid()) @map("group_member_id") @db.Uuid
  groupId                    String                          @map("group_id") @db.Uuid
  userId                     String?                         @map("user_id") @db.Uuid
  role                       String                          @db.VarChar(50)
  displayName                String                          @map("display_name") @db.VarChar(255)
  iconLetters                String                          @map("icon_letters") @db.VarChar(3)
  iconColor                  String                          @map("icon_color") @db.VarChar(7)
  email                      String?                         @db.VarChar(255)
  isRegistered               Boolean                         @default(false) @map("is_registered")
  joinedAt                   DateTime                        @default(now()) @map("joined_at") @db.Timestamp(6)
  isMuted                    Boolean                         @default(false) @map("is_muted")
  notifyRequests             Boolean                         @default(true) @map("notify_requests")
  notifyAllMessages          Boolean                         @default(true) @map("notify_all_messages")
  notifyMentionMessages      Boolean                         @default(true) @map("notify_mention_messages")
  notifyAllCalendar          Boolean                         @default(true) @map("notify_all_calendar")
  notifyMentionCalendar      Boolean                         @default(true) @map("notify_mention_calendar")
  notifyAllFinance           Boolean                         @default(true) @map("notify_all_finance")
  notifyMentionFinance       Boolean                         @default(true) @map("notify_mention_finance")
  isPinned                   Boolean                         @default(false) @map("is_pinned")
  pinnedOrder                Int?                            @map("pinned_order")
  grantedPermissions         AdminPermission[]               @relation("GrantingAdmin")
  receivedPermissions        AdminPermission[]               @relation("ReceivingAdmin")
  approvalVotes              ApprovalVote[]
  requestedApprovals         Approval[]                      @relation("ApprovalRequester")
  auditLogsPerformed         AuditLog[]
  createdEvents              CalendarEvent[]                 @relation("EventCreator")
  childResponsibilities      ChildResponsibilityEvent[]      @relation("ResponsibleChild")
  endResponsibilities        ChildResponsibilityEvent[]      @relation("EndResponsibleMember")
  startResponsibilities      ChildResponsibilityEvent[]      @relation("StartResponsibleMember")
  eventAttendances           EventAttendee[]
  financeMatterMemberships   FinanceMatterMember[]
  createdFinanceMatters      FinanceMatter[]                 @relation("FinanceMatterCreator")
  settledFinanceMatters      FinanceMatter[]                 @relation("FinanceMatterSettler")
  canceledFinanceMatters     FinanceMatter[]                 @relation("FinanceMatterCanceler")
  paymentsFrom               FinancePayment[]                @relation("PaymentFrom")
  paymentsTo                 FinancePayment[]                @relation("PaymentTo")
  group                      Group                           @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  user                       User?                           @relation(fields: [userId], references: [userId])
  messageGroupMemberships    MessageGroupMember[]
  createdMessageGroups       MessageGroup[]                  @relation("MessageGroupCreator")
  messageReadReceipts        MessageReadReceipt[]
  hiddenMessages             Message[]                       @relation("MessageHider")
  hiddenMedia                MessageMedia[]                  @relation("MediaHider")
  sentMessages               Message[]                       @relation("MessageSender")
  messageReactions           MessageReaction[]               @relation("MessageReactor")
  sentFinanceMatterMessages  FinanceMatterMessage[]          @relation("FinanceMatterMessageSender")
  relationshipsAsMember1     Relationship[]                  @relation("Member1")
  relationshipsAsMember2     Relationship[]                  @relation("Member2")
  wishListsForMember         WishList[]                      @relation("WishListForMember")
  wishListsCreated           WishList[]                      @relation("WishListCreator")
  purchasedWishListItems     WishListItem[]
  krisKringlesCreated        KrisKringle[]
  krisKringleParticipants    KrisKringleParticipant[]
  giftRegistriesCreated      GiftRegistry[]
  purchasedGiftItems         GiftItem[]                      @relation("ItemPurchaser")
  purchasedPersonalGiftItems PersonalGiftItem[]              @relation("PersonalItemPurchaser")
  personalGiftRegistryLinks  PersonalGiftRegistryGroupLink[] @relation("PersonalGiftRegistryLinker")
  personalItemRegistryLinks  PersonalItemRegistryGroupLink[] @relation("PersonalItemRegistryLinker")
  itemRegistriesCreated      ItemRegistry[]                  @relation("ItemRegistryCreator")
  wikiDocumentsCreated       WikiDocument[]                  @relation("WikiDocumentCreator")
  wikiRevisionsEdited        WikiRevision[]                  @relation("WikiRevisionEditor")
  documentsUploaded          GroupDocument[]                 @relation("DocumentUploader")
  documentsHidden            GroupDocument[]                 @relation("DocumentHider")
  logExportsCreated          LogExport[]                     @relation("LogExportCreator")
  initiatedCalls             PhoneCall[]                     @relation("CallInitiator")
  hiddenCallRecordings       PhoneCall[]                     @relation("CallRecordingHider")
  phoneCallParticipations    PhoneCallParticipant[]
  initiatedVideoCalls        VideoCall[]                     @relation("VideoCallInitiator")
  hiddenVideoRecordings      VideoCall[]                     @relation("VideoCallRecordingHider")
  videoCallParticipations    VideoCallParticipant[]

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([groupId, role])
  @@map("group_members")
}

model Relationship {
  relationshipId   String      @id @default(uuid()) @map("relationship_id") @db.Uuid
  groupId          String      @map("group_id") @db.Uuid
  memberId1        String      @map("member_id_1") @db.Uuid
  memberId2        String      @map("member_id_2") @db.Uuid
  relationshipType String      @map("relationship_type") @db.VarChar(100)
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  group            Group       @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  member1          GroupMember @relation("Member1", fields: [memberId1], references: [groupMemberId])
  member2          GroupMember @relation("Member2", fields: [memberId2], references: [groupMemberId])

  @@unique([groupId, memberId1, memberId2])
  @@index([groupId])
  @@map("relationships")
}

model GroupSettings {
  groupId String @id @map("group_id") @db.Uuid

  // Message Groups permissions
  messageGroupsVisibleToParents      Boolean @default(true) @map("message_groups_visible_to_parents")
  messageGroupsVisibleToAdults       Boolean @default(true) @map("message_groups_visible_to_adults")
  messageGroupsVisibleToCaregivers   Boolean @default(true) @map("message_groups_visible_to_caregivers")
  messageGroupsVisibleToChildren     Boolean @default(true) @map("message_groups_visible_to_children")
  messageGroupsVisibleToSupervisors  Boolean @default(true) @map("message_groups_visible_to_supervisors")
  messageGroupsCreatableByParents    Boolean @default(true) @map("message_groups_creatable_by_parents")
  messageGroupsCreatableByAdults     Boolean @default(true) @map("message_groups_creatable_by_adults")
  messageGroupsCreatableByCaregivers Boolean @default(true) @map("message_groups_creatable_by_caregivers")
  messageGroupsCreatableByChildren   Boolean @default(false) @map("message_groups_creatable_by_children")

  // Calendar permissions
  calendarVisibleToParents      Boolean @default(true) @map("calendar_visible_to_parents")
  calendarVisibleToAdults       Boolean @default(true) @map("calendar_visible_to_adults")
  calendarVisibleToCaregivers   Boolean @default(true) @map("calendar_visible_to_caregivers")
  calendarVisibleToChildren     Boolean @default(true) @map("calendar_visible_to_children")
  calendarVisibleToSupervisors  Boolean @default(false) @map("calendar_visible_to_supervisors")
  calendarCreatableByParents    Boolean @default(true) @map("calendar_creatable_by_parents")
  calendarCreatableByAdults     Boolean @default(true) @map("calendar_creatable_by_adults")
  calendarCreatableByCaregivers Boolean @default(true) @map("calendar_creatable_by_caregivers")
  calendarCreatableByChildren   Boolean @default(false) @map("calendar_creatable_by_children")

  // Finance permissions
  financeVisibleToParents      Boolean @default(true) @map("finance_visible_to_parents")
  financeVisibleToAdults       Boolean @default(true) @map("finance_visible_to_adults")
  financeVisibleToCaregivers   Boolean @default(false) @map("finance_visible_to_caregivers")
  financeVisibleToChildren     Boolean @default(false) @map("finance_visible_to_children")
  financeVisibleToSupervisors  Boolean @default(false) @map("finance_visible_to_supervisors")
  financeCreatableByParents    Boolean @default(true) @map("finance_creatable_by_parents")
  financeCreatableByAdults     Boolean @default(true) @map("finance_creatable_by_adults")
  financeCreatableByCaregivers Boolean @default(false) @map("finance_creatable_by_caregivers")
  financeCreatableByChildren   Boolean @default(false) @map("finance_creatable_by_children")

  // Gift Registry permissions
  giftRegistryVisibleToParents      Boolean @default(true) @map("gift_registry_visible_to_parents")
  giftRegistryVisibleToAdults       Boolean @default(true) @map("gift_registry_visible_to_adults")
  giftRegistryVisibleToCaregivers   Boolean @default(true) @map("gift_registry_visible_to_caregivers")
  giftRegistryVisibleToChildren     Boolean @default(true) @map("gift_registry_visible_to_children")
  giftRegistryVisibleToSupervisors  Boolean @default(false) @map("gift_registry_visible_to_supervisors")
  giftRegistryCreatableByParents    Boolean @default(true) @map("gift_registry_creatable_by_parents")
  giftRegistryCreatableByAdults     Boolean @default(true) @map("gift_registry_creatable_by_adults")
  giftRegistryCreatableByCaregivers Boolean @default(true) @map("gift_registry_creatable_by_caregivers")
  giftRegistryCreatableByChildren   Boolean @default(true) @map("gift_registry_creatable_by_children")

  // Secret Santa permissions
  secretSantaVisibleToParents      Boolean @default(true) @map("secret_santa_visible_to_parents")
  secretSantaVisibleToAdults       Boolean @default(true) @map("secret_santa_visible_to_adults")
  secretSantaVisibleToCaregivers   Boolean @default(true) @map("secret_santa_visible_to_caregivers")
  secretSantaVisibleToChildren     Boolean @default(true) @map("secret_santa_visible_to_children")
  secretSantaVisibleToSupervisors  Boolean @default(false) @map("secret_santa_visible_to_supervisors")
  secretSantaCreatableByParents    Boolean @default(true) @map("secret_santa_creatable_by_parents")
  secretSantaCreatableByAdults     Boolean @default(true) @map("secret_santa_creatable_by_adults")
  secretSantaCreatableByCaregivers Boolean @default(true) @map("secret_santa_creatable_by_caregivers")
  secretSantaCreatableByChildren   Boolean @default(false) @map("secret_santa_creatable_by_children")

  // Item Registry permissions
  itemRegistryVisibleToParents      Boolean @default(true) @map("item_registry_visible_to_parents")
  itemRegistryVisibleToAdults       Boolean @default(true) @map("item_registry_visible_to_adults")
  itemRegistryVisibleToCaregivers   Boolean @default(true) @map("item_registry_visible_to_caregivers")
  itemRegistryVisibleToChildren     Boolean @default(true) @map("item_registry_visible_to_children")
  itemRegistryVisibleToSupervisors  Boolean @default(false) @map("item_registry_visible_to_supervisors")
  itemRegistryCreatableByParents    Boolean @default(true) @map("item_registry_creatable_by_parents")
  itemRegistryCreatableByAdults     Boolean @default(true) @map("item_registry_creatable_by_adults")
  itemRegistryCreatableByCaregivers Boolean @default(true) @map("item_registry_creatable_by_caregivers")
  itemRegistryCreatableByChildren   Boolean @default(true) @map("item_registry_creatable_by_children")

  // Wiki permissions
  wikiVisibleToParents      Boolean @default(true) @map("wiki_visible_to_parents")
  wikiVisibleToAdults       Boolean @default(true) @map("wiki_visible_to_adults")
  wikiVisibleToCaregivers   Boolean @default(true) @map("wiki_visible_to_caregivers")
  wikiVisibleToChildren     Boolean @default(true) @map("wiki_visible_to_children")
  wikiVisibleToSupervisors  Boolean @default(false) @map("wiki_visible_to_supervisors")
  wikiCreatableByParents    Boolean @default(true) @map("wiki_creatable_by_parents")
  wikiCreatableByAdults     Boolean @default(true) @map("wiki_creatable_by_adults")
  wikiCreatableByCaregivers Boolean @default(true) @map("wiki_creatable_by_caregivers")
  wikiCreatableByChildren   Boolean @default(false) @map("wiki_creatable_by_children")

  // Secure Documents permissions
  documentsVisibleToParents      Boolean @default(true) @map("documents_visible_to_parents")
  documentsVisibleToAdults       Boolean @default(true) @map("documents_visible_to_adults")
  documentsVisibleToCaregivers   Boolean @default(false) @map("documents_visible_to_caregivers")
  documentsVisibleToChildren     Boolean @default(false) @map("documents_visible_to_children")
  documentsVisibleToSupervisors  Boolean @default(false) @map("documents_visible_to_supervisors")
  documentsCreatableByParents    Boolean @default(true) @map("documents_creatable_by_parents")
  documentsCreatableByAdults     Boolean @default(true) @map("documents_creatable_by_adults")
  documentsCreatableByCaregivers Boolean @default(false) @map("documents_creatable_by_caregivers")
  documentsCreatableByChildren   Boolean @default(false) @map("documents_creatable_by_children")

  // Phone Calls permissions
  phoneCallsVisibleToParents     Boolean @default(true) @map("phone_calls_visible_to_parents")
  phoneCallsVisibleToAdults      Boolean @default(true) @map("phone_calls_visible_to_adults")
  phoneCallsVisibleToCaregivers  Boolean @default(true) @map("phone_calls_visible_to_caregivers")
  phoneCallsVisibleToChildren    Boolean @default(true) @map("phone_calls_visible_to_children")
  phoneCallsVisibleToSupervisors Boolean @default(false) @map("phone_calls_visible_to_supervisors")
  phoneCallsUsableByParents      Boolean @default(true) @map("phone_calls_usable_by_parents")
  phoneCallsUsableByAdults       Boolean @default(true) @map("phone_calls_usable_by_adults")
  phoneCallsUsableByCaregivers   Boolean @default(true) @map("phone_calls_usable_by_caregivers")
  phoneCallsUsableByChildren     Boolean @default(true) @map("phone_calls_usable_by_children")

  // Video Calls permissions
  videoCallsVisibleToParents     Boolean @default(true) @map("video_calls_visible_to_parents")
  videoCallsVisibleToAdults      Boolean @default(true) @map("video_calls_visible_to_adults")
  videoCallsVisibleToCaregivers  Boolean @default(true) @map("video_calls_visible_to_caregivers")
  videoCallsVisibleToChildren    Boolean @default(true) @map("video_calls_visible_to_children")
  videoCallsVisibleToSupervisors Boolean @default(false) @map("video_calls_visible_to_supervisors")
  videoCallsUsableByParents      Boolean @default(true) @map("video_calls_usable_by_parents")
  videoCallsUsableByAdults       Boolean @default(true) @map("video_calls_usable_by_adults")
  videoCallsUsableByCaregivers   Boolean @default(true) @map("video_calls_usable_by_caregivers")
  videoCallsUsableByChildren     Boolean @default(true) @map("video_calls_usable_by_children")

  // Call Recording settings (on by default)
  recordPhoneCalls Boolean @default(true) @map("record_phone_calls")
  recordVideoCalls Boolean @default(true) @map("record_video_calls")

  // Other settings
  defaultCurrency String   @default("USD") @map("default_currency") @db.VarChar(3)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  group Group @relation(fields: [groupId], references: [groupId], onDelete: Cascade)

  @@map("group_settings")
}

model AdminPermission {
  permissionId                            String      @id @default(uuid()) @map("permission_id") @db.Uuid
  groupId                                 String      @map("group_id") @db.Uuid
  grantingAdminId                         String      @map("granting_admin_id") @db.Uuid
  receivingAdminId                        String      @map("receiving_admin_id") @db.Uuid
  autoApproveHideMessages                 Boolean     @default(false) @map("auto_approve_hide_messages")
  autoApproveAddPeople                    Boolean     @default(false) @map("auto_approve_add_people")
  autoApproveRemovePeople                 Boolean     @default(false) @map("auto_approve_remove_people")
  autoApproveAssignRoles                  Boolean     @default(false) @map("auto_approve_assign_roles")
  autoApproveChangeRoles                  Boolean     @default(false) @map("auto_approve_change_roles")
  autoApproveAssignRelationships          Boolean     @default(false) @map("auto_approve_assign_relationships")
  autoApproveChangeRelationships          Boolean     @default(false) @map("auto_approve_change_relationships")
  autoApproveCalendarEntries              Boolean     @default(false) @map("auto_approve_calendar_entries")
  autoApproveAssignChildrenToEvents       Boolean     @default(false) @map("auto_approve_assign_children_to_events")
  autoApproveAssignCaregiversToEvents     Boolean     @default(false) @map("auto_approve_assign_caregivers_to_events")
  autoApproveChangeMessageDeletionSetting Boolean     @default(false) @map("auto_approve_change_message_deletion_setting")
  createdAt                               DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                               DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  grantingAdmin                           GroupMember @relation("GrantingAdmin", fields: [grantingAdminId], references: [groupMemberId])
  group                                   Group       @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  receivingAdmin                          GroupMember @relation("ReceivingAdmin", fields: [receivingAdminId], references: [groupMemberId])

  @@unique([groupId, grantingAdminId, receivingAdminId])
  @@map("admin_permissions")
}

model MessageGroup {
  messageGroupId            String               @id @default(uuid()) @map("message_group_id") @db.Uuid
  groupId                   String               @map("group_id") @db.Uuid
  name                      String               @db.VarChar(255)
  createdBy                 String               @map("created_by") @db.Uuid
  createdAt                 DateTime             @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                 DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  lastMessageAt             DateTime?            @map("last_message_at") @db.Timestamp(6)
  isHidden                  Boolean              @default(false) @map("is_hidden")
  usersCanDeleteOwnMessages Boolean              @default(true) @map("users_can_delete_own_messages")
  members                   MessageGroupMember[]
  creator                   GroupMember          @relation("MessageGroupCreator", fields: [createdBy], references: [groupMemberId])
  group                     Group                @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  messages                  Message[]

  @@index([groupId])
  @@index([lastMessageAt])
  @@map("message_groups")
}

model MessageGroupMember {
  messageGroupId String       @map("message_group_id") @db.Uuid
  groupMemberId  String       @map("group_member_id") @db.Uuid
  joinedAt       DateTime     @default(now()) @map("joined_at") @db.Timestamp(6)
  isPinned       Boolean      @default(false) @map("is_pinned")
  isMuted        Boolean      @default(false) @map("is_muted")
  lastReadAt     DateTime?    @map("last_read_at") @db.Timestamp(6)
  groupMember    GroupMember  @relation(fields: [groupMemberId], references: [groupMemberId])
  messageGroup   MessageGroup @relation(fields: [messageGroupId], references: [messageGroupId], onDelete: Cascade)

  @@id([messageGroupId, groupMemberId])
  @@index([groupMemberId])
  @@map("message_group_members")
}

model Message {
  messageId      String               @id @default(uuid()) @map("message_id") @db.Uuid
  messageGroupId String               @map("message_group_id") @db.Uuid
  senderId       String               @map("sender_id") @db.Uuid
  content        String
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamp(6)
  editedAt       DateTime?            @map("edited_at") @db.Timestamp(6)
  isHidden       Boolean              @default(false) @map("is_hidden")
  hiddenAt       DateTime?            @map("hidden_at") @db.Timestamp(6)
  hiddenBy       String?              @map("hidden_by") @db.Uuid
  sentStatus     String               @default("pending") @map("sent_status") @db.VarChar(20)
  mentions       String[]             @db.Uuid
  media          MessageMedia[]
  readReceipts   MessageReadReceipt[]
  reactions      MessageReaction[]
  hider          GroupMember?         @relation("MessageHider", fields: [hiddenBy], references: [groupMemberId])
  messageGroup   MessageGroup         @relation(fields: [messageGroupId], references: [messageGroupId], onDelete: Cascade)
  sender         GroupMember          @relation("MessageSender", fields: [senderId], references: [groupMemberId])

  @@index([messageGroupId, createdAt(sort: Desc)])
  @@index([senderId])
  @@map("messages")
}

model MessageReaction {
  reactionId String      @id @default(uuid()) @map("reaction_id") @db.Uuid
  messageId  String      @map("message_id") @db.Uuid
  reactorId  String      @map("reactor_id") @db.Uuid
  emoji      String      @db.VarChar(50) // The emoji character(s)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  message    Message     @relation(fields: [messageId], references: [messageId], onDelete: Cascade)
  reactor    GroupMember @relation("MessageReactor", fields: [reactorId], references: [groupMemberId])

  @@unique([messageId, reactorId, emoji]) // One reaction per user per emoji per message
  @@index([messageId])
  @@index([reactorId])
  @@map("message_reactions")
}

model MessageMedia {
  mediaId       String         @id @default(uuid()) @map("media_id") @db.Uuid
  messageId     String         @map("message_id") @db.Uuid
  mediaType     String         @map("media_type") @db.VarChar(20)
  mimeType      String?        @map("mime_type") @db.VarChar(100) // Full MIME type (e.g., audio/webm, audio/mp4)
  s3Key         String         @map("s3_key") @db.VarChar(500)
  url           String
  thumbnailUrl  String?        @map("thumbnail_url")
  fileSizeBytes BigInt         @map("file_size_bytes")
  durationMs    Int?           @map("duration_ms") // Duration in milliseconds for audio/video
  uploadedAt    DateTime       @default(now()) @map("uploaded_at") @db.Timestamp(6)
  isHidden      Boolean        @default(false) @map("is_hidden")
  hiddenAt      DateTime?      @map("hidden_at") @db.Timestamp(6)
  hiddenBy      String?        @map("hidden_by") @db.Uuid
  mediaLogLinks MediaLogLink[]
  message       Message        @relation(fields: [messageId], references: [messageId], onDelete: Cascade)
  hider         GroupMember?   @relation("MediaHider", fields: [hiddenBy], references: [groupMemberId])

  @@index([messageId])
  @@map("message_media")
}

model MessageReadReceipt {
  messageId     String      @map("message_id") @db.Uuid
  groupMemberId String      @map("group_member_id") @db.Uuid
  readAt        DateTime    @default(now()) @map("read_at") @db.Timestamp(6)
  groupMember   GroupMember @relation(fields: [groupMemberId], references: [groupMemberId])
  message       Message     @relation(fields: [messageId], references: [messageId], onDelete: Cascade)

  @@id([messageId, groupMemberId])
  @@index([groupMemberId])
  @@map("message_read_receipts")
}

model CalendarEvent {
  eventId               String                     @id @default(uuid()) @map("event_id") @db.Uuid
  groupId               String                     @map("group_id") @db.Uuid
  title                 String                     @db.VarChar(255)
  startTime             DateTime                   @map("start_time") @db.Timestamp(6)
  endTime               DateTime                   @map("end_time") @db.Timestamp(6)
  notes                 String?
  createdBy             String                     @map("created_by") @db.Uuid
  createdAt             DateTime                   @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime                   @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  isRecurring           Boolean                    @default(false) @map("is_recurring")
  recurrencePattern     String?                    @map("recurrence_pattern") @db.VarChar(50)
  recurrenceInterval    Int?                       @map("recurrence_interval")
  recurrenceEndDate     DateTime?                  @map("recurrence_end_date") @db.Timestamp(6)
  parentEventId         String?                    @map("parent_event_id") @db.Uuid
  isResponsibilityEvent Boolean                    @default(false) @map("is_responsibility_event")
  creator               GroupMember                @relation("EventCreator", fields: [createdBy], references: [groupMemberId])
  group                 Group                      @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  parentEvent           CalendarEvent?             @relation("RecurringEvents", fields: [parentEventId], references: [eventId])
  childEvents           CalendarEvent[]            @relation("RecurringEvents")
  responsibilityEvents  ChildResponsibilityEvent[]
  attendees             EventAttendee[]

  @@index([groupId])
  @@index([startTime, endTime])
  @@index([isRecurring, parentEventId])
  @@map("calendar_events")
}

model EventAttendee {
  eventId       String        @map("event_id") @db.Uuid
  groupMemberId String        @map("group_member_id") @db.Uuid
  event         CalendarEvent @relation(fields: [eventId], references: [eventId], onDelete: Cascade)
  groupMember   GroupMember   @relation(fields: [groupMemberId], references: [groupMemberId])

  @@id([eventId, groupMemberId])
  @@index([groupMemberId])
  @@map("event_attendees")
}

model ChildResponsibilityEvent {
  responsibilityEventId            String        @id @default(uuid()) @map("responsibility_event_id") @db.Uuid
  eventId                          String        @map("event_id") @db.Uuid
  childId                          String        @map("child_id") @db.Uuid
  startResponsibilityType          String        @map("start_responsibility_type") @db.VarChar(20)
  startResponsibleMemberId         String?       @map("start_responsible_member_id") @db.Uuid
  startResponsibleOtherName        String?       @map("start_responsible_other_name") @db.VarChar(255)
  startResponsibleOtherIconLetters String?       @map("start_responsible_other_icon_letters") @db.VarChar(3)
  startResponsibleOtherColor       String?       @map("start_responsible_other_color") @db.VarChar(7)
  endResponsibilityType            String        @map("end_responsibility_type") @db.VarChar(20)
  endResponsibleMemberId           String?       @map("end_responsible_member_id") @db.Uuid
  endResponsibleOtherName          String?       @map("end_responsible_other_name") @db.VarChar(255)
  endResponsibleOtherIconLetters   String?       @map("end_responsible_other_icon_letters") @db.VarChar(3)
  endResponsibleOtherColor         String?       @map("end_responsible_other_color") @db.VarChar(7)
  child                            GroupMember   @relation("ResponsibleChild", fields: [childId], references: [groupMemberId])
  endResponsibleMember             GroupMember?  @relation("EndResponsibleMember", fields: [endResponsibleMemberId], references: [groupMemberId])
  event                            CalendarEvent @relation(fields: [eventId], references: [eventId], onDelete: Cascade)
  startResponsibleMember           GroupMember?  @relation("StartResponsibleMember", fields: [startResponsibleMemberId], references: [groupMemberId])

  @@index([eventId])
  @@index([childId])
  @@map("child_responsibility_events")
}

model FinanceMatter {
  financeMatterId String                 @id @default(uuid()) @map("finance_matter_id") @db.Uuid
  groupId         String                 @map("group_id") @db.Uuid
  name            String                 @db.VarChar(255)
  description     String?
  totalAmount     Decimal                @map("total_amount") @db.Decimal(12, 2)
  currency        String                 @db.VarChar(3)
  dueDate         DateTime?              @map("due_date") @db.Timestamp(6)
  createdBy       String                 @map("created_by") @db.Uuid
  createdAt       DateTime               @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime               @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  isSettled       Boolean                @default(false) @map("is_settled")
  settledAt       DateTime?              @map("settled_at") @db.Timestamp(6)
  settledBy       String?                @map("settled_by") @db.Uuid
  isCanceled      Boolean                @default(false) @map("is_canceled")
  canceledAt      DateTime?              @map("canceled_at") @db.Timestamp(6)
  canceledBy      String?                @map("canceled_by") @db.Uuid
  members         FinanceMatterMember[]
  creator         GroupMember            @relation("FinanceMatterCreator", fields: [createdBy], references: [groupMemberId])
  group           Group                  @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  settler         GroupMember?           @relation("FinanceMatterSettler", fields: [settledBy], references: [groupMemberId])
  canceler        GroupMember?           @relation("FinanceMatterCanceler", fields: [canceledBy], references: [groupMemberId])
  payments        FinancePayment[]
  messages        FinanceMatterMessage[]

  @@index([groupId])
  @@index([isSettled])
  @@index([isCanceled])
  @@map("finance_matters")
}

model FinanceMatterMember {
  financeMatterId    String        @map("finance_matter_id") @db.Uuid
  groupMemberId      String        @map("group_member_id") @db.Uuid
  expectedAmount     Decimal       @map("expected_amount") @db.Decimal(12, 2)
  expectedPercentage Decimal       @map("expected_percentage") @db.Decimal(5, 2)
  paidAmount         Decimal       @default(0) @map("paid_amount") @db.Decimal(12, 2)
  financeMatter      FinanceMatter @relation(fields: [financeMatterId], references: [financeMatterId], onDelete: Cascade)
  groupMember        GroupMember   @relation(fields: [groupMemberId], references: [groupMemberId])

  @@id([financeMatterId, groupMemberId])
  @@index([groupMemberId])
  @@map("finance_matter_members")
}

model FinancePayment {
  paymentId       String        @id @default(uuid()) @map("payment_id") @db.Uuid
  financeMatterId String        @map("finance_matter_id") @db.Uuid
  fromMemberId    String        @map("from_member_id") @db.Uuid
  toMemberId      String        @map("to_member_id") @db.Uuid
  amount          Decimal       @db.Decimal(12, 2)
  receiptImageUrl String?       @map("receipt_image_url")
  reportedAt      DateTime      @default(now()) @map("reported_at") @db.Timestamp(6)
  confirmedAt     DateTime?     @map("confirmed_at") @db.Timestamp(6)
  isConfirmed     Boolean       @default(false) @map("is_confirmed")
  financeMatter   FinanceMatter @relation(fields: [financeMatterId], references: [financeMatterId], onDelete: Cascade)
  fromMember      GroupMember   @relation("PaymentFrom", fields: [fromMemberId], references: [groupMemberId])
  toMember        GroupMember   @relation("PaymentTo", fields: [toMemberId], references: [groupMemberId])

  @@index([financeMatterId])
  @@index([fromMemberId, toMemberId])
  @@map("finance_payments")
}

model FinanceMatterMessage {
  messageId       String        @id @default(uuid()) @map("message_id") @db.Uuid
  financeMatterId String        @map("finance_matter_id") @db.Uuid
  senderId        String        @map("sender_id") @db.Uuid
  content         String        @db.Text
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamp(6)
  isHidden        Boolean       @default(false) @map("is_hidden")
  financeMatter   FinanceMatter @relation(fields: [financeMatterId], references: [financeMatterId], onDelete: Cascade)
  sender          GroupMember   @relation("FinanceMatterMessageSender", fields: [senderId], references: [groupMemberId])

  @@index([financeMatterId])
  @@index([senderId])
  @@index([createdAt])
  @@map("finance_matter_messages")
}

model Approval {
  approvalId                 String         @id @default(uuid()) @map("approval_id") @db.Uuid
  groupId                    String         @map("group_id") @db.Uuid
  approvalType               String         @map("approval_type") @db.VarChar(50)
  requestedBy                String         @map("requested_by") @db.Uuid
  requestedAt                DateTime       @default(now()) @map("requested_at") @db.Timestamp(6)
  status                     String         @default("pending") @db.VarChar(20)
  completedAt                DateTime?      @map("completed_at") @db.Timestamp(6)
  relatedEntityType          String?        @map("related_entity_type") @db.VarChar(50)
  relatedEntityId            String?        @map("related_entity_id") @db.Uuid
  approvalData               Json           @map("approval_data")
  requiresAllAdmins          Boolean        @default(false) @map("requires_all_admins")
  requiredApprovalPercentage Decimal        @default(50.00) @map("required_approval_percentage") @db.Decimal(5, 2)
  votes                      ApprovalVote[]
  group                      Group          @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  requester                  GroupMember    @relation("ApprovalRequester", fields: [requestedBy], references: [groupMemberId])

  @@index([groupId])
  @@index([status])
  @@index([requestedBy])
  @@map("approvals")
}

model ApprovalVote {
  approvalId     String      @map("approval_id") @db.Uuid
  adminId        String      @map("admin_id") @db.Uuid
  vote           String      @db.VarChar(10)
  isAutoApproved Boolean     @default(false) @map("is_auto_approved")
  votedAt        DateTime    @default(now()) @map("voted_at") @db.Timestamp(6)
  admin          GroupMember @relation(fields: [adminId], references: [groupMemberId])
  approval       Approval    @relation(fields: [approvalId], references: [approvalId], onDelete: Cascade)

  @@id([approvalId, adminId])
  @@index([adminId])
  @@map("approval_votes")
}

model AuditLog {
  logId            String       @id @default(uuid()) @map("log_id") @db.Uuid
  groupId          String       @map("group_id") @db.Uuid
  action           String       @db.VarChar(100)
  actionLocation   String?      @map("action_location") @db.VarChar(255)
  performedBy      String?      @map("performed_by") @db.Uuid
  performedByName  String?      @map("performed_by_name") @db.VarChar(255)
  performedByEmail String?      @map("performed_by_email") @db.VarChar(255)
  performedAt      DateTime     @default(now()) @map("performed_at") @db.Timestamp(6)
  messageContent   String?      @map("message_content")
  mediaLinks       String[]     @map("media_links")
  logData          Json?        @map("log_data")
  group            Group        @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  performer        GroupMember? @relation(fields: [performedBy], references: [groupMemberId])

  @@index([groupId])
  @@index([groupId, performedAt(sort: Desc)])
  @@index([performedBy])
  @@map("audit_logs")
}

model MediaLogLink {
  linkId            String       @id @default(uuid()) @map("link_id") @db.Uuid
  logExportId       String       @map("log_export_id") @db.Uuid
  mediaId           String       @map("media_id") @db.Uuid
  accessToken       String       @map("access_token") @db.VarChar(500)
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  expiresAt         DateTime     @map("expires_at") @db.Timestamp(6)
  accessedCount     Int          @default(0) @map("accessed_count")
  media             MessageMedia @relation(fields: [mediaId], references: [mediaId])
  LogExport         LogExport?   @relation(fields: [logExportExportId], references: [exportId])
  logExportExportId String?      @db.Uuid

  @@index([logExportId])
  @@index([expiresAt])
  @@map("media_log_links")
}

model StorageUsage {
  usageId          String   @id @default(uuid()) @map("usage_id") @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  groupId          String   @map("group_id") @db.Uuid
  mediaType        String   @map("media_type") @db.VarChar(20)
  fileCount        Int      @default(0) @map("file_count")
  totalBytes       BigInt   @default(0) @map("total_bytes")
  lastCalculatedAt DateTime @default(now()) @map("last_calculated_at") @db.Timestamp(6)
  group            Group    @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, groupId, mediaType])
  @@index([userId])
  @@index([groupId])
  @@map("storage_usage")
}

model PinnedItem {
  pinId    String   @id @default(uuid()) @map("pin_id") @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  itemType String   @map("item_type") @db.VarChar(50)
  itemId   String   @map("item_id") @db.Uuid
  pinnedAt DateTime @default(now()) @map("pinned_at") @db.Timestamp(6)
  pinOrder Int      @map("pin_order")
  user     User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, itemType, itemId])
  @@index([userId, itemType, pinOrder])
  @@map("pinned_items")
}

// ============================================
// GIFT REGISTRY MODELS
// ============================================

model WishList {
  wishListId              String                   @id @default(uuid()) @map("wish_list_id") @db.Uuid
  groupId                 String                   @map("group_id") @db.Uuid
  name                    String                   @db.VarChar(255)
  description             String?                  @db.Text
  forMemberId             String                   @map("for_member_id") @db.Uuid
  createdBy               String                   @map("created_by") @db.Uuid
  createdAt               DateTime                 @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt               DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  isHidden                Boolean                  @default(false) @map("is_hidden")
  items                   WishListItem[]
  group                   Group                    @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  forMember               GroupMember              @relation("WishListForMember", fields: [forMemberId], references: [groupMemberId])
  creator                 GroupMember              @relation("WishListCreator", fields: [createdBy], references: [groupMemberId])
  krisKringleParticipants KrisKringleParticipant[]

  @@index([groupId])
  @@index([forMemberId])
  @@map("wish_lists")
}

model WishListItem {
  itemId      String       @id @default(uuid()) @map("item_id") @db.Uuid
  wishListId  String       @map("wish_list_id") @db.Uuid
  name        String       @db.VarChar(255)
  description String?      @db.Text
  url         String?      @db.Text
  imageUrl    String?      @map("image_url") @db.Text
  price       Decimal?     @db.Decimal(12, 2)
  priority    String       @default("medium") @db.VarChar(20)
  isPurchased Boolean      @default(false) @map("is_purchased")
  purchasedBy String?      @map("purchased_by") @db.Uuid
  purchasedAt DateTime?    @map("purchased_at") @db.Timestamp(6)
  notes       String?      @db.Text
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  isHidden    Boolean      @default(false) @map("is_hidden")
  wishList    WishList     @relation(fields: [wishListId], references: [wishListId], onDelete: Cascade)
  purchaser   GroupMember? @relation(fields: [purchasedBy], references: [groupMemberId])

  @@index([wishListId])
  @@index([isPurchased])
  @@map("wish_list_items")
}

// ============================================
// KRIS KRINGLE / SECRET SANTA MODELS
// ============================================

model KrisKringle {
  krisKringleId     String                    @id @default(uuid()) @map("kris_kringle_id") @db.Uuid
  groupId           String                    @map("group_id") @db.Uuid
  name              String                    @db.VarChar(255)
  description       String?                   @db.Text
  occasion          String?                   @db.VarChar(255)
  priceLimit        Decimal?                  @map("price_limit") @db.Decimal(12, 2)
  assigningDateTime DateTime?                 @map("assigning_date_time") @db.Timestamp(6)
  exchangeDate      DateTime?                 @map("exchange_date") @db.Timestamp(6)
  webToken          String?                   @unique @map("web_token") @db.VarChar(64)
  createdBy         String                    @map("created_by") @db.Uuid
  createdAt         DateTime                  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime                  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  status            String                    @default("draft") @db.VarChar(20)
  isHidden          Boolean                   @default(false) @map("is_hidden")
  isAssigned        Boolean                   @default(false) @map("is_assigned")
  participants      KrisKringleParticipant[]
  matches           KrisKringleMatch[]
  exclusions        KrisKringleExclusion[]
  giftRegistries    SecretSantaGiftRegistry[]
  group             Group                     @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  creator           GroupMember               @relation(fields: [createdBy], references: [groupMemberId])

  @@index([groupId])
  @@index([status])
  @@index([webToken])
  @@map("kris_kringles")
}

model KrisKringleParticipant {
  participantId         String                   @id @default(uuid()) @map("participant_id") @db.Uuid
  krisKringleId         String                   @map("kris_kringle_id") @db.Uuid
  groupMemberId         String?                  @map("group_member_id") @db.Uuid
  email                 String                   @db.VarChar(255)
  name                  String                   @db.VarChar(255)
  passcode              String                   @db.VarChar(6)
  hasJoined             Boolean                  @default(false) @map("has_joined")
  hasViewed             Boolean                  @default(false) @map("has_viewed")
  viewedAt              DateTime?                @map("viewed_at") @db.Timestamp(6)
  wishListId            String?                  @map("wish_list_id") @db.Uuid
  ssGiftRegistryId      String?                  @unique @map("ss_gift_registry_id") @db.Uuid
  joinedAt              DateTime?                @map("joined_at") @db.Timestamp(6)
  initialEmailSentAt    DateTime?                @map("initial_email_sent_at") @db.Timestamp(6)
  assignmentEmailSentAt DateTime?                @map("assignment_email_sent_at") @db.Timestamp(6)
  createdAt             DateTime                 @default(now()) @map("created_at") @db.Timestamp(6)
  krisKringle           KrisKringle              @relation(fields: [krisKringleId], references: [krisKringleId], onDelete: Cascade)
  groupMember           GroupMember?             @relation(fields: [groupMemberId], references: [groupMemberId])
  wishList              WishList?                @relation(fields: [wishListId], references: [wishListId])
  ssGiftRegistry        SecretSantaGiftRegistry? @relation(fields: [ssGiftRegistryId], references: [registryId])
  givingTo              KrisKringleMatch[]       @relation("GivingMatches")
  receivingFrom         KrisKringleMatch[]       @relation("ReceivingMatches")
  exclusionsFrom        KrisKringleExclusion[]   @relation("ExclusionPerson1")
  exclusionsTo          KrisKringleExclusion[]   @relation("ExclusionPerson2")

  @@index([krisKringleId])
  @@index([groupMemberId])
  @@index([email])
  @@map("kris_kringle_participants")
}

model KrisKringleMatch {
  matchId       String                 @id @default(uuid()) @map("match_id") @db.Uuid
  krisKringleId String                 @map("kris_kringle_id") @db.Uuid
  giverId       String                 @map("giver_id") @db.Uuid
  receiverId    String                 @map("receiver_id") @db.Uuid
  createdAt     DateTime               @default(now()) @map("created_at") @db.Timestamp(6)
  krisKringle   KrisKringle            @relation(fields: [krisKringleId], references: [krisKringleId], onDelete: Cascade)
  giver         KrisKringleParticipant @relation("GivingMatches", fields: [giverId], references: [participantId])
  receiver      KrisKringleParticipant @relation("ReceivingMatches", fields: [receiverId], references: [participantId])

  @@unique([krisKringleId, giverId])
  @@index([krisKringleId])
  @@map("kris_kringle_matches")
}

model KrisKringleExclusion {
  exclusionId    String                 @id @default(uuid()) @map("exclusion_id") @db.Uuid
  krisKringleId  String                 @map("kris_kringle_id") @db.Uuid
  participant1Id String                 @map("participant1_id") @db.Uuid
  participant2Id String                 @map("participant2_id") @db.Uuid
  createdAt      DateTime               @default(now()) @map("created_at") @db.Timestamp(6)
  krisKringle    KrisKringle            @relation(fields: [krisKringleId], references: [krisKringleId], onDelete: Cascade)
  participant1   KrisKringleParticipant @relation("ExclusionPerson1", fields: [participant1Id], references: [participantId])
  participant2   KrisKringleParticipant @relation("ExclusionPerson2", fields: [participant2Id], references: [participantId])

  @@unique([krisKringleId, participant1Id, participant2Id])
  @@index([krisKringleId])
  @@map("kris_kringle_exclusions")
}

// ============================================
// SECRET SANTA TEMPORARY GIFT REGISTRY
// (For SS participants to create gift lists, deleted with SS event)
// ============================================

model SecretSantaGiftRegistry {
  registryId    String                  @id @default(uuid()) @map("registry_id") @db.Uuid
  krisKringleId String                  @map("kris_kringle_id") @db.Uuid
  name          String                  @db.VarChar(255)
  createdAt     DateTime                @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  krisKringle   KrisKringle             @relation(fields: [krisKringleId], references: [krisKringleId], onDelete: Cascade)
  participant   KrisKringleParticipant?
  items         SecretSantaGiftItem[]

  @@index([krisKringleId])
  @@map("secret_santa_gift_registries")
}

model SecretSantaGiftItem {
  itemId       String                  @id @default(uuid()) @map("item_id") @db.Uuid
  registryId   String                  @map("registry_id") @db.Uuid
  title        String                  @db.VarChar(255)
  link         String?                 @db.Text
  photoUrl     String?                 @map("photo_url") @db.Text
  cost         Decimal?                @db.Decimal(10, 2)
  description  String?                 @db.Text
  displayOrder Int                     @default(0) @map("display_order")
  isPurchased  Boolean                 @default(false) @map("is_purchased")
  purchasedAt  DateTime?               @map("purchased_at") @db.Timestamp(6)
  createdAt    DateTime                @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  registry     SecretSantaGiftRegistry @relation(fields: [registryId], references: [registryId], onDelete: Cascade)

  @@index([registryId, displayOrder])
  @@map("secret_santa_gift_items")
}

// ============================================
// SHAREABLE GIFT REGISTRY MODELS
// (Different from wish_lists which are for Secret Santa only)
// ============================================

model GiftRegistry {
  registryId  String   @id @default(uuid()) @map("registry_id") @db.Uuid
  groupId     String   @map("group_id") @db.Uuid
  creatorId   String   @map("creator_id") @db.Uuid
  name        String   @db.VarChar(255)
  sharingType String   @map("sharing_type") @db.VarChar(20) // public, passcode, group_only
  passcode    String?  @db.VarChar(6)
  webToken    String   @unique @map("web_token") @db.VarChar(32)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  group   Group       @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  creator GroupMember @relation(fields: [creatorId], references: [groupMemberId], onDelete: Cascade)
  items   GiftItem[]

  @@index([groupId])
  @@index([creatorId])
  @@index([webToken])
  @@map("gift_registries")
}

model GiftItem {
  itemId          String    @id @default(uuid()) @map("item_id") @db.Uuid
  registryId      String    @map("registry_id") @db.Uuid
  title           String    @db.VarChar(255)
  link            String?   @db.Text
  photoUrl        String?   @map("photo_url") @db.Text
  cost            Decimal?  @db.Decimal(10, 2)
  description     String?   @db.Text
  displayOrder    Int       @default(0) @map("display_order")
  isPurchased     Boolean   @default(false) @map("is_purchased")
  purchasedBy     String?   @map("purchased_by") @db.Uuid
  purchasedByName String?   @map("purchased_by_name") @db.VarChar(255)
  purchasedAt     DateTime? @map("purchased_at") @db.Timestamp(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  registry  GiftRegistry @relation(fields: [registryId], references: [registryId], onDelete: Cascade)
  purchaser GroupMember? @relation("ItemPurchaser", fields: [purchasedBy], references: [groupMemberId], onDelete: SetNull)

  @@index([registryId, displayOrder])
  @@index([purchasedBy])
  @@map("gift_items")
}

// ============================================
// PERSONAL GIFT REGISTRY MODELS (User-Level)
// ============================================

model PersonalGiftRegistry {
  registryId  String   @id @default(uuid()) @map("registry_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  name        String   @db.VarChar(255)
  sharingType String   @map("sharing_type") @db.VarChar(30) // external_link, external_link_passcode
  webToken    String   @unique @map("web_token") @db.VarChar(32)
  passcode    String?  @db.VarChar(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  user       User                            @relation("PersonalGiftRegistries", fields: [userId], references: [userId], onDelete: Cascade)
  items      PersonalGiftItem[]
  groupLinks PersonalGiftRegistryGroupLink[]

  @@index([userId])
  @@index([webToken])
  @@map("personal_gift_registries")
}

model PersonalGiftItem {
  itemId          String    @id @default(uuid()) @map("item_id") @db.Uuid
  registryId      String    @map("registry_id") @db.Uuid
  title           String    @db.VarChar(255)
  link            String?   @db.Text
  photoUrl        String?   @map("photo_url") @db.Text
  cost            Decimal?  @db.Decimal(10, 2)
  description     String?   @db.Text
  displayOrder    Int       @default(0) @map("display_order")
  isPurchased     Boolean   @default(false) @map("is_purchased")
  purchasedBy     String?   @map("purchased_by") @db.Uuid
  purchasedByName String?   @map("purchased_by_name") @db.VarChar(255)
  purchasedAt     DateTime? @map("purchased_at") @db.Timestamp(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  registry  PersonalGiftRegistry @relation(fields: [registryId], references: [registryId], onDelete: Cascade)
  purchaser GroupMember?         @relation("PersonalItemPurchaser", fields: [purchasedBy], references: [groupMemberId], onDelete: SetNull)

  @@index([registryId, displayOrder])
  @@index([purchasedBy])
  @@map("personal_gift_items")
}

model PersonalGiftRegistryGroupLink {
  linkId     String   @id @default(uuid()) @map("link_id") @db.Uuid
  registryId String   @map("registry_id") @db.Uuid
  groupId    String   @map("group_id") @db.Uuid
  linkedBy   String   @map("linked_by") @db.Uuid
  linkedAt   DateTime @default(now()) @map("linked_at") @db.Timestamp(6)

  registry PersonalGiftRegistry @relation(fields: [registryId], references: [registryId], onDelete: Cascade)
  group    Group                @relation("PersonalGiftRegistryLinks", fields: [groupId], references: [groupId], onDelete: Cascade)
  linker   GroupMember          @relation("PersonalGiftRegistryLinker", fields: [linkedBy], references: [groupMemberId], onDelete: Cascade)

  @@unique([registryId, groupId])
  @@index([registryId])
  @@index([groupId])
  @@map("personal_gift_registry_group_links")
}

// ============================================
// PERSONAL ITEM REGISTRY MODELS (User-Level)
// For books, tools, borrowable items
// ============================================

model PersonalItemRegistry {
  registryId  String   @id @default(uuid()) @map("registry_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  name        String   @db.VarChar(255)
  sharingType String   @map("sharing_type") @db.VarChar(30) // external_link, external_link_passcode
  webToken    String   @unique @map("web_token") @db.VarChar(32)
  passcode    String?  @db.VarChar(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  user       User                            @relation("PersonalItemRegistries", fields: [userId], references: [userId], onDelete: Cascade)
  items      PersonalItemRegistryItem[]
  groupLinks PersonalItemRegistryGroupLink[]

  @@index([userId])
  @@index([webToken])
  @@map("personal_item_registries")
}

model PersonalItemRegistryItem {
  itemId              String   @id @default(uuid()) @map("item_id") @db.Uuid
  registryId          String   @map("registry_id") @db.Uuid
  title               String   @db.VarChar(255)
  description         String?  @db.Text
  photoUrl            String?  @map("photo_url") @db.Text
  storageLocation     String?  @map("storage_location") @db.VarChar(255)
  category            String?  @db.VarChar(100)
  currentlyBorrowedBy String?  @map("currently_borrowed_by") @db.VarChar(255)
  replacementValue    Decimal? @map("replacement_value") @db.Decimal(10, 2)
  displayOrder        Int      @default(0) @map("display_order")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  registry PersonalItemRegistry @relation(fields: [registryId], references: [registryId], onDelete: Cascade)

  @@index([registryId, displayOrder])
  @@map("personal_item_registry_items")
}

model PersonalItemRegistryGroupLink {
  linkId     String   @id @default(uuid()) @map("link_id") @db.Uuid
  registryId String   @map("registry_id") @db.Uuid
  groupId    String   @map("group_id") @db.Uuid
  linkedBy   String   @map("linked_by") @db.Uuid
  linkedAt   DateTime @default(now()) @map("linked_at") @db.Timestamp(6)

  registry PersonalItemRegistry @relation(fields: [registryId], references: [registryId], onDelete: Cascade)
  group    Group                @relation("PersonalItemRegistryLinks", fields: [groupId], references: [groupId], onDelete: Cascade)
  linker   GroupMember          @relation("PersonalItemRegistryLinker", fields: [linkedBy], references: [groupMemberId], onDelete: Cascade)

  @@unique([registryId, groupId])
  @@index([registryId])
  @@index([groupId])
  @@map("personal_item_registry_group_links")
}

// ============================================
// GROUP ITEM REGISTRY MODELS (Group-Level)
// For books, tools, borrowable items within a group
// ============================================

model ItemRegistry {
  registryId  String   @id @default(uuid()) @map("registry_id") @db.Uuid
  groupId     String   @map("group_id") @db.Uuid
  creatorId   String   @map("creator_id") @db.Uuid
  name        String   @db.VarChar(255)
  sharingType String   @map("sharing_type") @db.VarChar(20) // group_only, external_link, external_link_passcode
  passcode    String?  @db.VarChar(6)
  webToken    String?  @unique @map("web_token") @db.VarChar(32)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  group   Group              @relation("ItemRegistries", fields: [groupId], references: [groupId], onDelete: Cascade)
  creator GroupMember        @relation("ItemRegistryCreator", fields: [creatorId], references: [groupMemberId], onDelete: Cascade)
  items   ItemRegistryItem[]

  @@index([groupId])
  @@index([creatorId])
  @@index([webToken])
  @@map("item_registries")
}

model ItemRegistryItem {
  itemId              String   @id @default(uuid()) @map("item_id") @db.Uuid
  registryId          String   @map("registry_id") @db.Uuid
  title               String   @db.VarChar(255)
  description         String?  @db.Text
  photoUrl            String?  @map("photo_url") @db.Text
  storageLocation     String?  @map("storage_location") @db.VarChar(255)
  category            String?  @db.VarChar(100)
  currentlyBorrowedBy String?  @map("currently_borrowed_by") @db.VarChar(255)
  replacementValue    Decimal? @map("replacement_value") @db.Decimal(10, 2)
  displayOrder        Int      @default(0) @map("display_order")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  registry ItemRegistry @relation(fields: [registryId], references: [registryId], onDelete: Cascade)

  @@index([registryId, displayOrder])
  @@map("item_registry_items")
}

// ============================================
// WIKI DOCUMENT MODELS
// ============================================

model WikiDocument {
  documentId String   @id @default(uuid()) @map("document_id") @db.Uuid
  groupId    String   @map("group_id") @db.Uuid
  title      String   @db.VarChar(255)
  content    String   @db.Text
  createdBy  String   @map("created_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  isHidden   Boolean  @default(false) @map("is_hidden")

  group     Group          @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  creator   GroupMember    @relation("WikiDocumentCreator", fields: [createdBy], references: [groupMemberId])
  revisions WikiRevision[]

  @@index([groupId])
  @@index([createdAt])
  @@map("wiki_documents")
}

model WikiRevision {
  revisionId String   @id @default(uuid()) @map("revision_id") @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  title      String   @db.VarChar(255)
  content    String   @db.Text
  editedBy   String   @map("edited_by") @db.Uuid
  editedAt   DateTime @default(now()) @map("edited_at") @db.Timestamp(6)
  changeNote String?  @map("change_note") @db.VarChar(255)

  document WikiDocument @relation(fields: [documentId], references: [documentId], onDelete: Cascade)
  editor   GroupMember  @relation("WikiRevisionEditor", fields: [editedBy], references: [groupMemberId])

  @@index([documentId])
  @@index([editedAt])
  @@map("wiki_revisions")
}

// ============================================
// GROUP DOCUMENT STORAGE
// Secure document storage for groups
// ============================================

model GroupDocument {
  documentId    String    @id @default(uuid()) @map("document_id") @db.Uuid
  groupId       String    @map("group_id") @db.Uuid
  fileName      String    @map("file_name") @db.VarChar(255)
  fileId        String    @map("file_id") @db.Uuid
  fileSizeBytes BigInt    @map("file_size_bytes")
  mimeType      String    @map("mime_type") @db.VarChar(100)
  uploadedBy    String    @map("uploaded_by") @db.Uuid
  uploadedAt    DateTime  @default(now()) @map("uploaded_at") @db.Timestamp(6)
  isHidden      Boolean   @default(false) @map("is_hidden")
  hiddenAt      DateTime? @map("hidden_at") @db.Timestamp(6)
  hiddenBy      String?   @map("hidden_by") @db.Uuid

  group    Group        @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  uploader GroupMember  @relation("DocumentUploader", fields: [uploadedBy], references: [groupMemberId])
  hider    GroupMember? @relation("DocumentHider", fields: [hiddenBy], references: [groupMemberId])

  @@index([groupId])
  @@index([uploadedAt])
  @@map("group_documents")
}

model LogExport {
  exportId      String         @id @default(uuid()) @map("export_id") @db.Uuid
  groupId       String         @map("group_id") @db.Uuid
  createdBy     String         @map("created_by") @db.Uuid
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  filters       Json           @map("filters")
  filePath      String         @map("file_path") @db.VarChar(500)
  fileName      String         @map("file_name") @db.VarChar(255)
  fileSizeBytes BigInt         @map("file_size_bytes")
  isHidden      Boolean        @default(false) @map("is_hidden")
  group         Group          @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  creator       GroupMember    @relation("LogExportCreator", fields: [createdBy], references: [groupMemberId])
  mediaLinks    MediaLogLink[]

  @@index([groupId])
  @@index([createdAt])
  @@map("log_exports")
}

// ============================================
// PHONE CALL MODELS
// ============================================

model PhoneCall {
  callId      String    @id @default(uuid()) @map("call_id") @db.Uuid
  groupId     String    @map("group_id") @db.Uuid
  initiatedBy String    @map("initiated_by") @db.Uuid
  startedAt   DateTime  @default(now()) @map("started_at") @db.Timestamp(6)
  connectedAt DateTime? @map("connected_at") @db.Timestamp(6)
  endedAt     DateTime? @map("ended_at") @db.Timestamp(6)
  status      String    @default("ringing") @db.VarChar(20) // ringing, active, ended, missed
  durationMs  Int?      @map("duration_ms")

  // Recording - legacy single file (kept for backwards compatibility)
  recordingFileId     String?   @map("recording_file_id") @db.Uuid
  recordingUrl        String?   @map("recording_url")
  recordingStatus     String?   @map("recording_status") @db.VarChar(20) // processing, ready, failed
  recordingDurationMs Int?      @map("recording_duration_ms")
  recordingSizeBytes  BigInt?   @map("recording_size_bytes")
  recordingIsHidden   Boolean   @default(false) @map("recording_is_hidden")
  recordingHiddenBy   String?   @map("recording_hidden_by") @db.Uuid
  recordingHiddenAt   DateTime? @map("recording_hidden_at") @db.Timestamp(6)

  group           Group                     @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  initiator       GroupMember               @relation("CallInitiator", fields: [initiatedBy], references: [groupMemberId])
  recordingHider  GroupMember?              @relation("CallRecordingHider", fields: [recordingHiddenBy], references: [groupMemberId])
  participants    PhoneCallParticipant[]
  recordingChunks PhoneCallRecordingChunk[]

  @@index([groupId])
  @@index([status])
  @@index([startedAt])
  @@map("phone_calls")
}

model PhoneCallParticipant {
  callId        String    @map("call_id") @db.Uuid
  groupMemberId String    @map("group_member_id") @db.Uuid
  invitedAt     DateTime  @default(now()) @map("invited_at") @db.Timestamp(6)
  respondedAt   DateTime? @map("responded_at") @db.Timestamp(6)
  joinedAt      DateTime? @map("joined_at") @db.Timestamp(6)
  leftAt        DateTime? @map("left_at") @db.Timestamp(6)
  status        String    @default("invited") @db.VarChar(20) // invited, accepted, rejected, joined, left, missed

  call        PhoneCall   @relation(fields: [callId], references: [callId], onDelete: Cascade)
  participant GroupMember @relation(fields: [groupMemberId], references: [groupMemberId])

  @@id([callId, groupMemberId])
  @@index([groupMemberId])
  @@index([status])
  @@map("phone_call_participants")
}

// ============================================
// VIDEO CALL MODELS
// ============================================

model VideoCall {
  callId      String    @id @default(uuid()) @map("call_id") @db.Uuid
  groupId     String    @map("group_id") @db.Uuid
  initiatedBy String    @map("initiated_by") @db.Uuid
  startedAt   DateTime  @default(now()) @map("started_at") @db.Timestamp(6)
  connectedAt DateTime? @map("connected_at") @db.Timestamp(6)
  endedAt     DateTime? @map("ended_at") @db.Timestamp(6)
  status      String    @default("ringing") @db.VarChar(20) // ringing, active, ended, missed
  durationMs  Int?      @map("duration_ms")

  // Recording - legacy single file (kept for backwards compatibility)
  recordingFileId     String?   @map("recording_file_id") @db.Uuid
  recordingUrl        String?   @map("recording_url")
  recordingStatus     String?   @map("recording_status") @db.VarChar(20) // processing, ready, failed
  recordingDurationMs Int?      @map("recording_duration_ms")
  recordingSizeBytes  BigInt?   @map("recording_size_bytes")
  recordingIsHidden   Boolean   @default(false) @map("recording_is_hidden")
  recordingHiddenBy   String?   @map("recording_hidden_by") @db.Uuid
  recordingHiddenAt   DateTime? @map("recording_hidden_at") @db.Timestamp(6)

  group           Group                     @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  initiator       GroupMember               @relation("VideoCallInitiator", fields: [initiatedBy], references: [groupMemberId])
  recordingHider  GroupMember?              @relation("VideoCallRecordingHider", fields: [recordingHiddenBy], references: [groupMemberId])
  participants    VideoCallParticipant[]
  recordingChunks VideoCallRecordingChunk[]

  @@index([groupId])
  @@index([status])
  @@index([startedAt])
  @@map("video_calls")
}

model VideoCallParticipant {
  callId        String    @map("call_id") @db.Uuid
  groupMemberId String    @map("group_member_id") @db.Uuid
  invitedAt     DateTime  @default(now()) @map("invited_at") @db.Timestamp(6)
  respondedAt   DateTime? @map("responded_at") @db.Timestamp(6)
  joinedAt      DateTime? @map("joined_at") @db.Timestamp(6)
  leftAt        DateTime? @map("left_at") @db.Timestamp(6)
  status        String    @default("invited") @db.VarChar(20) // invited, accepted, rejected, joined, left, missed

  call        VideoCall   @relation(fields: [callId], references: [callId], onDelete: Cascade)
  participant GroupMember @relation(fields: [groupMemberId], references: [groupMemberId])

  @@id([callId, groupMemberId])
  @@index([groupMemberId])
  @@index([status])
  @@map("video_call_participants")
}

// ============================================
// RECORDING CHUNK MODELS (for gapless chunked recording)
// Each chunk is 2 minutes max, uploaded independently
// ============================================

model PhoneCallRecordingChunk {
  chunkId    String   @id @default(uuid()) @map("chunk_id") @db.Uuid
  callId     String   @map("call_id") @db.Uuid
  chunkIndex Int      @map("chunk_index") // 0, 1, 2, ... for ordering
  fileId     String   @map("file_id") @db.Uuid
  fileUrl    String   @map("file_url")
  durationMs Int      @map("duration_ms")
  sizeBytes  BigInt   @map("size_bytes")
  startedAt  DateTime @map("started_at") @db.Timestamp(6) // When this chunk's recording started
  endedAt    DateTime @map("ended_at") @db.Timestamp(6) // When this chunk's recording ended
  status     String   @default("processing") @map("status") @db.VarChar(20) // processing, ready, failed
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  call PhoneCall @relation(fields: [callId], references: [callId], onDelete: Cascade)

  @@unique([callId, chunkIndex])
  @@index([callId])
  @@index([status])
  @@map("phone_call_recording_chunks")
}

model VideoCallRecordingChunk {
  chunkId    String   @id @default(uuid()) @map("chunk_id") @db.Uuid
  callId     String   @map("call_id") @db.Uuid
  chunkIndex Int      @map("chunk_index") // 0, 1, 2, ... for ordering
  fileId     String   @map("file_id") @db.Uuid
  fileUrl    String   @map("file_url")
  durationMs Int      @map("duration_ms")
  sizeBytes  BigInt   @map("size_bytes")
  startedAt  DateTime @map("started_at") @db.Timestamp(6) // When this chunk's recording started
  endedAt    DateTime @map("ended_at") @db.Timestamp(6) // When this chunk's recording ended
  status     String   @default("processing") @map("status") @db.VarChar(20) // processing, ready, failed
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  call VideoCall @relation(fields: [callId], references: [callId], onDelete: Cascade)

  @@unique([callId, chunkIndex])
  @@index([callId])
  @@index([status])
  @@map("video_call_recording_chunks")
}

// ============================================
// BILLING HISTORY (Manual Billing - Option B)
// ============================================

model BillingHistory {
  billingId              String   @id @default(uuid()) @map("billing_id") @db.Uuid
  userId                 String   @map("user_id") @db.Uuid
  stripePaymentIntentId  String?  @map("stripe_payment_intent_id") @db.VarChar(255)
  amount                 Int // Amount in cents (e.g., 300 = $3.00)
  currency               String   @default("aud") @db.VarChar(3)
  status                 String   @db.VarChar(20) // succeeded, failed, pending, refunded
  description            String   @db.VarChar(500)
  baseSubscriptionAmount Int      @map("base_subscription_amount") // Base subscription in cents
  storagePacks           Int      @default(0) @map("storage_packs") // Number of additional storage packs
  storagePackAmount      Int      @default(0) @map("storage_pack_amount") // Per-pack amount in cents
  periodStart            DateTime @map("period_start") @db.Timestamp(6)
  periodEnd              DateTime @map("period_end") @db.Timestamp(6)
  failureReason          String?  @map("failure_reason") @db.VarChar(500)
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("billing_history")
}

// ============================================
// SUPPORT AUDIT LOG
// Immutable log of all support actions - cannot be edited or deleted
// ============================================

model SupportAuditLog {
  logId     String   @id @default(uuid()) @map("log_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Who performed the action
  performedById    String @map("performed_by_id") @db.Uuid
  performedByEmail String @map("performed_by_email") @db.VarChar(255)

  // Who was affected (target user)
  targetUserId    String @map("target_user_id") @db.Uuid
  targetUserEmail String @map("target_user_email") @db.VarChar(255)

  // Action details
  action        String  @db.VarChar(100) // grant_subscription, revoke_subscription, grant_support, revoke_support, lock_user, unlock_user
  details       String? @db.Text // JSON or text with additional details
  previousValue String? @map("previous_value") @db.Text // State before change
  newValue      String? @map("new_value") @db.Text // State after change

  // IP and user agent for security
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.VarChar(500)

  performedBy User @relation("SupportActionPerformer", fields: [performedById], references: [userId])
  targetUser  User @relation("SupportActionTarget", fields: [targetUserId], references: [userId])

  @@index([performedById])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
  @@map("support_audit_logs")
}

// ============================================
// WEBRTC SIGNALING
// Ephemeral storage for WebRTC signals between Lambda invocations
// Signals are auto-cleaned after 5 minutes
// ============================================

model WebRTCSignal {
  signalId   String    @id @default(uuid()) @map("signal_id") @db.Uuid
  callId     String    @map("call_id") @db.Uuid
  callType   String    @map("call_type") @db.VarChar(10) // 'video' or 'phone'
  fromPeerId String    @map("from_peer_id") @db.VarChar(100) // groupMemberId or 'recorder'
  toPeerId   String    @map("to_peer_id") @db.VarChar(100) // groupMemberId or 'recorder'
  signalType String    @map("signal_type") @db.VarChar(20) // 'offer', 'answer', 'ice-candidate'
  signalData Json      @map("signal_data") // The actual SDP or ICE candidate data
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  isConsumed Boolean   @default(false) @map("is_consumed")
  consumedAt DateTime? @map("consumed_at") @db.Timestamp(6)

  @@index([callId, toPeerId, isConsumed])
  @@index([createdAt])
  @@map("webrtc_signals")
}
